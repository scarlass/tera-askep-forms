<script type="text/javascript">
    /**
     * -Important Notes-
     * PLEASE READ THIS BEFORE IMPLEMENTING THE FORM
     *
     * If you find any --multiple cloned select2 element-- after you update any of this form information,
     * even without changing the form content,
     * please do the following:
     * 1. Copy the entire form content to your text editor
     * 2. Find any select2 generated element (should be a span class right after the </select> closing tag element)
     *    It may looks like this : <span class="select2 select2-container select2-container--default" dir="ltr" style="width: 100%;"><span class="selection"><span class="select2-selection select2-selection--single" role="combobox" aria-haspopup="true" aria-expanded="false" tabindex="-1" aria-labelledby="select2-pilih_riwayat-container"><span class="select2-selection__rendered" id="select2-pilih_riwayat-container"><span class="select2-selection__placeholder">Select pilih riwayat</span></span><span class="select2-selection__arrow" role="presentation"><b role="presentation"></b></span></span></span><span class="dropdown-wrapper" aria-hidden="true"></span></span>
     * 3. Delete that element, and save the file
     *
     * Any question? just ask me!
     *
     * ********************************************************
     * -Small notes-
     * You can skip this, unless you have spare time to read ðŸ˜‹
     * Just a little note, and some changelog
     *
     * 4/15/25
     * I have spent a lot of time fixing these Jquery anomalies for days...
     * A lot of ridiculously confusing behavior happened, especially that select2 things...
     * In addition that supposedly simple chaining sequence for select inputs, starting from #pilih-riwayat
     * and then #pilih-riwayat-kunjungan-sebelumnya and finally reaching a dynamic input of medications...
     * It was all fun and easy until I have to show the data...
     * Ridiculously, quite difficult... and confusing
     * Like how tf value of other inputs changed by itself after other selecting inputs...
     * I've tried using AI sht but it ain't doing anything, other than I have to rewrite all of my codes from scratch, again...
     * But, finally.. it seems to be working now.
     * Though, it's not necessarily a clean but a brute-force solution...
     * Changing value on its own huh, well I'll just change it back to the original value right after...
     * Well whatever, nevertheless it's done, i don't want doing these kind of anomaly stuffs again...
     *
     * 6/5/25
     * - Update to handle new data structure and validation logic
     * - Added validation for mandatory fields, new collapsible sections
     *
     * 10/9/25
     * - Refactored code structure for better readability and maintainability; modularized javascript logics
     * - New update for MedicationStatement, ClinicalImpression,  CarePlan
     *
     * @namespace SatusehatForm
     * @description JavaScript module for handling Satusehat form functionalities including datepickers, select2 dropdowns, dynamic input displays, collapsible sections, and form validation.
     * @author azhari@teramedik.com
     */
    window.SatusehatForm = (function ($) {
        // Private variables
        let initialized =
            typeof window.initialized !== "undefined"
                ? window.initialized
                : false;
        let dataJSON = "{MYJSON}";

        // Resolve global variables
        if (!window.PID) window.PID = resolveTemplate("{PID}", null);
        if (!window.REGPID) window.REGPID = resolveTemplate("{REGPID}", null);

        // Private utility functions

        /**
         * Resolve template
         *
         * @function resolveTemplate
         * @return string
         **/
        function resolveTemplate(val, fallback = "") {
            if (
                typeof val === "undefined" ||
                val === null ||
                (typeof val === "string" && /^\{.*\}$/.test(val.trim()))
            ) {
                return fallback;
            }
            return val;
        }

        function isPlaceholderValue(value) {
            return typeof value === "string" && /^\{.*\}$/.test(value.trim());
        }

        function toBoolean(value) {
            if (typeof value === "string") {
                const normalized = value.trim();
                if (!normalized || isPlaceholderValue(normalized)) {
                    return false;
                }
                const lowered = normalized.toLowerCase();
                return ["true", "t", "1", "y", "yes"].includes(lowered);
            }
            if (typeof value === "number") {
                return value === 1;
            }
            if (typeof value === "boolean") {
                return value;
            }
            if (value === null || typeof value === "undefined") {
                return false;
            }
            return Boolean(value);
        }

        function hasEffectiveValue(value) {
            if (value === undefined || value === null) {
                return false;
            }
            if (typeof value === "string") {
                const trimmed = value.trim();
                if (!trimmed || isPlaceholderValue(trimmed)) {
                    return false;
                }
            }
            return true;
        }

        function toBooleanOrNull(value) {
            return hasEffectiveValue(value) ? toBoolean(value) : null;
        }

        function isPlainObject(value) {
            return Object.prototype.toString.call(value) === "[object Object]";
        }

        function toArray(value) {
            if (Array.isArray(value)) {
                return value;
            }
            if (typeof value === "string") {
                const trimmed = value.trim();
                if (!trimmed || isPlaceholderValue(trimmed)) {
                    return [];
                }
                try {
                    const parsed = JSON.parse(trimmed);
                    if (Array.isArray(parsed)) {
                        return parsed;
                    }
                    if (isPlainObject(parsed)) {
                        return Object.values(parsed);
                    }
                    return [];
                } catch (error) {
                    return [];
                }
            }
            if (isPlainObject(value)) {
                return Object.values(value);
            }
            return [];
        }

        function escapeHtml(value) {
            if (value === null || value === undefined) {
                return "";
            }
            return String(value)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function parseDateValue(value) {
            if (!value) {
                return null;
            }
            if (value instanceof Date) {
                return isNaN(value.getTime()) ? null : value;
            }
            if (typeof value === "number") {
                if (value > 1e12) {
                    const date = new Date(value);
                    return isNaN(date.getTime()) ? null : date;
                }
                if (value > 1e9) {
                    const date = new Date(value * 1000);
                    return isNaN(date.getTime()) ? null : date;
                }
                return null;
            }
            if (typeof value === "string") {
                const trimmed = value.trim();
                if (!trimmed || isPlaceholderValue(trimmed)) {
                    return null;
                }
                if (/^\d+$/.test(trimmed)) {
                    const numeric = parseInt(trimmed, 10);
                    return parseDateValue(numeric);
                }
                const date = new Date(trimmed);
                return isNaN(date.getTime()) ? null : date;
            }
            return null;
        }

        const RIWAYAT_OPTIONS = {
            internal: { value: "resep_internal", label: "Resep Internal" },
        };

        function validateData(value) {
            if (typeof value === "string") {
                value = value.trim();
            } else if (Array.isArray(value)) {
                if (value.length === 0) {
                    return false;
                }
            } else if (typeof value === "object") {
                for (const prop in value) {
                    if (Object.hasOwn(value, prop)) {
                        return false;
                    }
                }
            }
            if (
                value === undefined ||
                value === null ||
                value === "" ||
                value === NaN
            ) {
                return false;
            } else {
                return true;
            }
        }

        function getSelect2Container($field) {
            if (
                !$field ||
                !$field.length ||
                !$field.hasClass("select2-hidden-accessible")
            ) {
                return $();
            }
            const select2Instance = $field.data("select2");
            if (
                select2Instance &&
                select2Instance.$container &&
                select2Instance.$container.length
            ) {
                return select2Instance.$container;
            }
            const $direct = $field.next(".select2-container, .select2");
            if ($direct.length) {
                return $direct;
            }
            return $field.siblings(".select2-container, .select2").first();
        }

        function showError($field, message) {
            removeValidation($field);
            $field.addClass("is-invalid");
            $field.attr("aria-invalid", "true");
            const $container = getSelect2Container($field);
            if ($container.length) {
                $container.addClass("is-invalid");
                $container.attr("aria-invalid", "true");
                $container.find(".select2-selection").addClass("is-invalid");
                $container
                    .find(".select2-selection")
                    .attr("aria-invalid", "true");
            }
            if ($field.next(".invalid-feedback").length === 0) {
                $field.after(`<div class="invalid-feedback">${message}</div>`);
            }
        }

        function removeValidation($field) {
            $field.removeClass("is-invalid");
            $field.removeAttr("aria-invalid");
            const $container = getSelect2Container($field);
            if ($container.length) {
                $container.removeClass("is-invalid");
                $container.removeAttr("aria-invalid");
                $container.find(".select2-selection").removeClass("is-invalid");
                $container
                    .find(".select2-selection")
                    .removeAttr("aria-invalid");
            }
            const $formGroup = $field.closest(".form-group");
            if ($formGroup.length) {
                $formGroup
                    .find(".select2, .select2-container")
                    .removeClass("is-invalid")
                    .removeAttr("aria-invalid");
                $formGroup
                    .find(".select2-selection")
                    .removeClass("is-invalid")
                    .removeAttr("aria-invalid");
                $formGroup
                    .find('[aria-invalid="true"]')
                    .removeAttr("aria-invalid");
                $formGroup.find(".is-invalid").removeClass("is-invalid");
            }
            $field.next(".invalid-feedback").remove();
        }

        function validateField($field) {
            if (
                $field.prop("disabled") ||
                !$field.closest(".collapsible-content").is(":visible")
            ) {
                removeValidation($field);
                return true;
            }
            const isSelect2Field = $field.hasClass("select2-hidden-accessible");
            const $select2Container = isSelect2Field
                ? $field.next(".select2")
                : $();
            const isEffectivelyHidden = isSelect2Field
                ? $select2Container.length
                    ? !$select2Container.is(":visible")
                    : !$field.is(":visible")
                : !$field.is(":visible");
            if (isEffectivelyHidden) {
                removeValidation($field);
                return true;
            }
            let isValid = true;
            const value = $field.val();
            if ($field.attr("data-is-mandatory") === "true") {
                if ($field.hasClass("select2-hidden-accessible")) {
                    if (
                        !value ||
                        (Array.isArray(value) && value.length === 0)
                    ) {
                        showError($field, "Field ini wajib diisi");
                        isValid = false;
                    }
                } else {
                    if (!value || value.trim() === "") {
                        showError($field, "Field ini wajib diisi");
                        isValid = false;
                    }
                }
            }
            if (isValid) {
                removeValidation($field);
            }
            return isValid;
        }

        function setIhsLabel() {
            let pasienLabel = "";
            if (dataJSON && dataJSON["label_ihs_pasien"]) {
                pasienLabel = dataJSON["label_ihs_pasien"];
            } else if ($("#nama_pasien").val()) {
                pasienLabel = $("#nama_pasien").val();
            } else {
                pasienLabel = "{PATIENT_NAME_SATUSEHAT}";
            }
            $("#label-ihs-pasien").text(pasienLabel);

            let dokterLabel = "";
            if (dataJSON && dataJSON["label_ihs_dokter"]) {
                dokterLabel = dataJSON["label_ihs_dokter"];
            } else if ($("#dokter_penanggung_jawab").val()) {
                dokterLabel = $("#dokter_penanggung_jawab").val();
            } else {
                dokterLabel = "{DPJP}";
            }
            $("#label-ihs-dokter").text(dokterLabel);
        }

        function checkIhsPasien() {
            setIhsLabel();
            const ihsPasien = $("#ihs_pasien").val();
            const $alertPasien = $("#alert-ihs-pasien");
            if (!ihsPasien) {
                $alertPasien
                    .removeClass("alert-success")
                    .addClass("alert-danger")
                    .find("i.fa")
                    .removeClass()
                    .addClass("fa fa-exclamation-triangle");
                $alertPasien.find("#status-ihs-pasien").text("tidak");
                $alertPasien.slideDown();
            } else {
                $alertPasien
                    .removeClass("alert-danger")
                    .addClass("alert-success")
                    .find("i.fa")
                    .removeClass()
                    .addClass("fa fa-check-circle");
                $alertPasien.find("#status-ihs-pasien").text("telah");
                $alertPasien.slideDown();
            }

            const ihsDokter = $("#ihs_dokter").val();
            const $alertDokter = $("#alert-ihs-dokter");
            if (!ihsDokter) {
                $alertDokter
                    .removeClass("alert-success")
                    .addClass("alert-danger")
                    .find("i.fa")
                    .removeClass()
                    .addClass("fa fa-exclamation-triangle");
                $alertDokter.find("#status-ihs-dokter").text("tidak");
                $alertDokter.slideDown();
            } else {
                $alertDokter
                    .removeClass("alert-danger")
                    .addClass("alert-success")
                    .find("i.fa")
                    .removeClass()
                    .addClass("fa fa-check-circle");
                $alertDokter.find("#status-ihs-dokter").text("telah");
                $alertDokter.slideDown();
            }
        }

        function fillData(
            el,
            selector = "",
            index = null,
            defaultEvent = true,
        ) {
            const $element = $(el);
            if (!$element || !$element.length) {
                return;
            }
            selector = selector || "#" + $element.attr("id");
            if (!selector) {
                return;
            }
            let data = dataJSON[selector.slice(1)];
            if (Array.isArray(data) && !isNaN(+index) && index !== null) {
                data = data[index];
                if (data === undefined) return;
            }
            if (data === undefined || data === null) {
                return;
            }

            const isMultiple =
                $element.prop("multiple") ||
                typeof $element.attr("multiple") !== "undefined";
            const previousValue = isMultiple
                ? ($element.val() || []).map((value) =>
                      value === null || value === undefined
                          ? ""
                          : String(value),
                  )
                : $element.val();

            const resolveRawCollection = (raw) => {
                if (Array.isArray(raw)) {
                    return raw;
                }
                if (typeof raw === "string") {
                    const trimmed = raw.trim();
                    if (!trimmed || isPlaceholderValue(trimmed)) {
                        return [];
                    }
                    if (
                        (trimmed.startsWith("[") && trimmed.endsWith("]")) ||
                        (trimmed.startsWith("{") && trimmed.endsWith("}"))
                    ) {
                        try {
                            const parsed = JSON.parse(trimmed);
                            return resolveRawCollection(parsed);
                        } catch (error) {
                            // ignore parse error and fall back to single value
                        }
                    }
                    return [trimmed];
                }
                if (isPlainObject(raw)) {
                    return Object.values(raw);
                }
                if (raw === undefined || raw === null) {
                    return [];
                }
                return [raw];
            };

            const extractValue = (value) => {
                if (value === undefined || value === null) {
                    return "";
                }
                if (Array.isArray(value)) {
                    for (const entry of value) {
                        const extracted = extractValue(entry);
                        if (extracted) {
                            return extracted;
                        }
                    }
                    return "";
                }
                if (isPlainObject(value)) {
                    const candidateKeys = [
                        "value",
                        "id",
                        "kode",
                        "code",
                        "uuid",
                        "text",
                        "label",
                        "nama_obat",
                        "namaObat",
                    ];
                    for (const key of candidateKeys) {
                        if (hasEffectiveValue(value[key])) {
                            return String(value[key]);
                        }
                    }
                    const fallbackEntries = Object.values(value);
                    if (fallbackEntries.length) {
                        return extractValue(fallbackEntries[0]);
                    }
                    return "";
                }
                if (typeof value === "string") {
                    const trimmed = value.trim();
                    if (!trimmed || isPlaceholderValue(trimmed)) {
                        return "";
                    }
                    if (
                        (trimmed.startsWith("[") && trimmed.endsWith("]")) ||
                        (trimmed.startsWith("{") && trimmed.endsWith("}"))
                    ) {
                        try {
                            const parsed = JSON.parse(trimmed);
                            return extractValue(parsed);
                        } catch (error) {
                            // ignore parse error and use trimmed string
                        }
                    }
                    return trimmed;
                }
                return String(value);
            };

            const normalizeArrayValues = (value) => {
                return resolveRawCollection(value)
                    .map((item) => extractValue(item))
                    .filter((item) => hasEffectiveValue(item))
                    .map(String);
            };

            const normalizeSingleValue = (value) => {
                const resolved = extractValue(value);
                return hasEffectiveValue(resolved) ? String(resolved) : "";
            };

            const emitChange = () => {
                if ($element.hasClass("select2-hidden-accessible")) {
                    $element.trigger("change.select2");
                    if (!defaultEvent) {
                        $element.trigger("select2:close");
                    }
                } else {
                    $element.trigger("change");
                }
            };

            const revertValue = () => {
                $element.val(previousValue ?? (isMultiple ? [] : ""));
                emitChange();
            };

            if (isMultiple) {
                const targetValues = normalizeArrayValues(data);
                if (!targetValues.length) {
                    return;
                }
                $element.val(targetValues);
                const applied = $element.val();
                const appliedArray = Array.isArray(applied)
                    ? applied.map((item) =>
                          item === null || item === undefined
                              ? ""
                              : String(item),
                      )
                    : [];
                const mismatch =
                    targetValues.length &&
                    !targetValues.every((value) =>
                        appliedArray.includes(value),
                    );
                if (mismatch) {
                    revertValue();
                    return;
                }
                emitChange();
                validateField($element);
                if (
                    typeof SatusehatForm !== "undefined" &&
                    SatusehatForm.CollapsibleSections &&
                    typeof SatusehatForm.CollapsibleSections.refreshForField ===
                        "function"
                ) {
                    SatusehatForm.CollapsibleSections.refreshForField($element);
                }
            } else {
                const targetValue = normalizeSingleValue(data);
                if (targetValue === "") {
                    return;
                }
                $element.val(targetValue);
                const applied = $element.val();
                const appliedValue =
                    applied === null || applied === undefined
                        ? ""
                        : String(applied);
                if (targetValue !== appliedValue) {
                    revertValue();
                    return;
                }
                emitChange();
                validateField($element);
                if (
                    typeof SatusehatForm !== "undefined" &&
                    SatusehatForm.CollapsibleSections &&
                    typeof SatusehatForm.CollapsibleSections.refreshForField ===
                        "function"
                ) {
                    SatusehatForm.CollapsibleSections.refreshForField($element);
                }
            }
        }

        function formatICD(icd) {
            if (!icd.id) return icd.text;
            return $("<span>" + icd.text + "</span>");
        }

        function formatICDSelection(icd) {
            return icd.text;
        }

        function checkExistingICD(data) {
            let allIcds = $("#icd10").val();
            let duplicates = false;
            let counts = {};
            $.each(allIcds, function (i, value) {
                counts[value] = (counts[value] || 0) + 1;
                if (counts[value] > 1) {
                    duplicates = true;
                    let values = $("#icd10").val();
                    values.pop();
                    $("#icd10").val(values).trigger("change");
                    $.bigBox({
                        title: "ICD sudah diinputkan",
                        content: data.text + " sudah ada didalam list",
                        color: "#C46A69",
                        icon: "fa fa-warning shake animated",
                    });
                    return false;
                }
            });
        }

        function ImageToText(img_id, img_val) {
            if (typeof img_val === "undefined" || img_val == "") {
                $("#def_img_" + img_id).css({
                    display: "",
                    "font-style": "italic",
                    width: "100px",
                    height: "100px",
                });
                $("#image_paraf_" + img_id).css("display", "none");
            } else {
                $("#def_img_" + img_id).text("");
                $("#def_img_" + img_id).css("display", "none");
                $("#image_paraf_" + img_id).attr("src", "" + img_val + "");
                $("#image_paraf_" + img_id).css({
                    display: "",
                    "margin-left": "50px",
                    width: "100px",
                    height: "100px",
                });
                $("#paraf_" + img_id).val(img_val);
            }
        }

        function PopupCenter(url, title, w, h) {
            let dualScreenLeft =
                window.screenLeft != undefined
                    ? window.screenLeft
                    : screen.left;
            let dualScreenTop =
                window.screenTop != undefined ? window.screenTop : screen.top;
            let width = window.innerWidth
                ? window.innerWidth
                : document.documentElement.clientWidth
                  ? document.documentElement.clientWidth
                  : screen.width;
            let height = window.innerHeight
                ? window.innerHeight
                : document.documentElement.clientHeight
                  ? document.documentElement.clientHeight
                  : screen.height;
            let left = width / 2 - w / 2 + dualScreenLeft + 100;
            let top = height / 2 - h / 2 + dualScreenTop + 100;
            let newWindow = window.open(
                url,
                title,
                "scrollbars=yes, width=" +
                    w +
                    ", height=" +
                    h +
                    ", top=" +
                    top +
                    ", left=" +
                    left,
            );
            if (window.focus) newWindow.focus();
        }

        // Public API
        return {
            /**
             * Initializes the Satusehat form functionalities
             * @function init
             * @memberof SatusehatForm
             * @description Initializes datepickers, select2 dropdowns, input displays, collapsible sections, and sets up event listeners for validation and data population.
             */
            init: function () {
                try {
                    dataJSON = JSON.parse(dataJSON);
                } catch (error) {
                    let cleanedString = dataJSON
                        .replace(/[\r\n]+/g, " ")
                        .replace(/\t+/g, " ")
                        .replace(/[\x00-\x1F\x7F-\x9F]/g, "")
                        .replace(/\s+/g, " ");
                    try {
                        dataJSON = JSON.parse(cleanedString);
                    } catch (error) {
                        // console.error('JSON parsing failed after cleanup');
                        dataJSON = {};
                    }
                }

                if (isPlainObject(dataJSON)) {
                    if (dataJSON["pilih_riwayat"] === "resep_luar") {
                        dataJSON["pilih_riwayat"] =
                            RIWAYAT_OPTIONS.internal.value;
                    }
                    if (!hasEffectiveValue(dataJSON["pilih_riwayat"])) {
                        dataJSON["pilih_riwayat"] =
                            RIWAYAT_OPTIONS.internal.value;
                    }
                }

                this.Medication.currentMedications =
                    this.Medication.getDefaultMedications();

                this.Medication.primeRiwayatOptions();
                this.Datepicker.init();
                const finalizeInitialization = () => {
                    this.DisplayInput.init();
                    this.Medication.initializeDefaults();
                    this.Medication.renderSelectionState(
                        $("#pilih_riwayat").val(),
                        { hydrate: true },
                    );
                    this.CollapsibleSections.init();
                };
                let select2InitResult;
                try {
                    select2InitResult = this.Select2.init();
                } catch (error) {
                    if (window.console && console.warn) {
                        console.warn(
                            "SatusehatForm.Select2.init threw an error",
                            error,
                        );
                    }
                    finalizeInitialization();
                    return;
                }
                if (
                    select2InitResult &&
                    typeof select2InitResult.then === "function"
                ) {
                    select2InitResult
                        .then(() => {
                            finalizeInitialization();
                        })
                        .catch((error) => {
                            if (window.console && console.warn) {
                                console.warn(
                                    "SatusehatForm.Select2.init failed",
                                    error,
                                );
                            }
                            finalizeInitialization();
                        });
                } else {
                    finalizeInitialization();
                }

                $(document).on(
                    "select2:close select2:select select2:unselect change",
                    'select[data-is-mandatory="true"]',
                    function () {
                        validateField($(this));
                    },
                );
                $(document).on(
                    "blur",
                    'input[data-is-mandatory="true"], textarea[data-is-mandatory="true"]',
                    function () {
                        validateField($(this));
                    },
                );

                $("#nama_pasien").val(
                    resolveTemplate(
                        (dataJSON && dataJSON["nama_pasien"]) ??
                            "{PATIENT_NAME_SATUSEHAT}",
                        "",
                    ),
                );
                $("#ihs_pasien").val(
                    resolveTemplate(
                        (dataJSON && dataJSON["ihs_pasien"]) ?? "{IHS_PASIEN}",
                        "",
                    ),
                );
                $("#nik").val(
                    resolveTemplate(
                        (dataJSON && dataJSON["nik"]) ?? "{NO_KTP}",
                        "",
                    ),
                );
                $("#departemen_layanan").val(
                    resolveTemplate(
                        (dataJSON && dataJSON["departemen_layanan"]) ??
                            "{DEPT}",
                        "",
                    ),
                );
                $("#nomor_registrasi").val(
                    resolveTemplate(
                        (dataJSON && dataJSON["nomor_registrasi"]) ??
                            "{NO_REG}",
                        "",
                    ),
                );
                $("#tanggal_registrasi").val(
                    resolveTemplate(
                        (dataJSON && dataJSON["tanggal_registrasi"]) ??
                            "{TGL_REG}",
                        "",
                    ),
                );
                $("#dokter_penanggung_jawab").val(
                    resolveTemplate(
                        (dataJSON && dataJSON["dokter_penanggung_jawab"]) ??
                            "{DPJP}",
                        "",
                    ),
                );
                $("#ihs_dokter").val(
                    resolveTemplate(
                        (dataJSON && dataJSON["ihs_dokter"]) ?? "{IHS_DPJP}",
                        "",
                    ),
                );
                $("#temporary_diagnosis").val(
                    resolveTemplate(
                        (dataJSON && dataJSON["temporary_diagnosis"]) ??
                            "{TEMPORARY_DIAGNOSIS}",
                        "",
                    ),
                );
                $("#pemeriksaan_penunjang").val(
                    resolveTemplate(
                        (dataJSON && dataJSON["pemeriksaan_penunjang"]) ??
                            "{LAB_ORDER}",
                        "",
                    ),
                );
                $("#keluhan_kunjungan_sekarang_soap").val(
                    resolveTemplate("{KELUHAN_UTAMA}", "").trim(),
                );
                checkIhsPasien();
                this.TTD.SetTTD();

                $("input[readonly]").each(function () {
                    if (!$(this).attr("placeholder")) {
                        $(this).attr("placeholder", "-");
                    }
                });
            },

            /**
             * Datepicker functionalities
             * @namespace Datepicker
             * @description Initializes datepicker elements and handles their configuration and behavior.
             **/
            Datepicker: {
                init: function () {
                    $(".datepicker")
                        .removeClass("hasDatepicker")
                        .off("click.datepicker");
                    if ($.fn.datepicker) {
                        $(".datepicker").each(function () {
                            let dataDateFormat =
                                $(this).attr("data-dateformat") || "dd/mm/yy";
                            if (
                                $(this)
                                    .closest(".collapsible-content")
                                    .is(":hidden") &&
                                $(this).closest(".collapsible-content").length >
                                    0
                            ) {
                                return;
                            }
                            $(this).datepicker({
                                dateFormat: dataDateFormat,
                                prevText: '<i class="fa fa-chevron-left"></i>',
                                nextText: '<i class="fa fa-chevron-right"></i>',
                                todayBtn: "linked",
                            });
                        });
                    }
                },
                initWithin: function (container) {
                    container.find(".datepicker").each(function () {
                        if (!$(this).hasClass("hasDatepicker")) {
                            let dataDateFormat =
                                $(this).attr("data-dateformat") || "dd/mm/yy";
                            $(this).datepicker({
                                dateFormat: dataDateFormat,
                                prevText: '<i class="fa fa-chevron-left"></i>',
                                nextText: '<i class="fa fa-chevron-right"></i>',
                                todayBtn: "linked",
                            });
                        }
                    });
                },
            },

            /**
             * Select2 dropdown functionalities
             * @namespace Select2
             * @description Initializes select2 dropdowns, handles dynamic data loading, and manages ICD-10 selections with custom formatting and duplicate checks.
             **/
            Select2: {
                init: async function () {
                    $(".select2").each(function (e) {
                        const $select = $(this);
                        if (!$select.data("select2")) {
                            const isDisplay =
                                $select.hasClass("select2-display");
                            const name = this.name
                                ?.replaceAll("_", " ")
                                ?.replace("[]", "");
                            const select2Options = {
                                placeholder: isDisplay
                                    ? ($(this).data("display") ?? name ?? "") +
                                      " tidak tersedia"
                                    : "Select " + name,
                                allowClear: true,
                                width: "100%",
                                dropdownAutoWidth: true,
                                escapeMarkup: (markup) => markup,
                            };
                            if (
                                this.id === "pilih_riwayat_kunjungan_sebelumnya"
                            ) {
                                select2Options.templateResult = (data) => {
                                    if (
                                        !data ||
                                        !data.element ||
                                        data.loading
                                    ) {
                                        return escapeHtml(data?.text ?? "");
                                    }
                                    const status =
                                        data.element.getAttribute(
                                            "data-visit-status",
                                        );
                                    if (status === "sent") {
                                        const label = escapeHtml(
                                            data.text ?? "",
                                        );
                                        return `
                                            <span class="visit-option visit-option--sent">
                                                <i class="fa fa-ban visit-option-icon" aria-hidden="true"></i>
                                                <span class="visit-option-label">${label}</span>
                                                <span class="visit-option-tag">Terkirim</span>
                                            </span>
                                        `;
                                    }
                                    return escapeHtml(data.text ?? "");
                                };
                            }
                            $select.select2(select2Options);
                            if (
                                SatusehatForm &&
                                SatusehatForm.Medication &&
                                typeof SatusehatForm.Medication
                                    .clearFieldValidation === "function"
                            ) {
                                SatusehatForm.Medication.clearFieldValidation(
                                    $select,
                                );
                            }
                            // $(this).on('select2:open', function () {
                            //     const $dropdown = $('.select2-dropdown');
                            //     const minWidth = $dropdown.css('min-width');
                            //     $dropdown.find('.select2-results').css('max-width', minWidth);
                            // });
                        }
                    });

                    fillData($("#pilih_riwayat"));
                    SatusehatForm.Medication.clearFieldValidation(
                        $("#pilih_riwayat"),
                    );
                    fillData($("#prognosis_term"));
                    fillData($("#layanan_tindak_lajut"));
                    fillData($("#layanan_fasilitas"));
                    fillData($("#doctor_ttd"));
                    fillData($("#nurse_ttd"));

                    const combos = [
                        {
                            el: "#keluhan_kunjungan_sebelumnya",
                            type: "keluhan",
                        },
                        { el: "#keluhan_kunjungan_sekarang", type: "keluhan" },
                        {
                            el: "#status_tindak_lanjut",
                            type: "careplan_status",
                        },
                        {
                            el: "#tujuan_tindak_lanjut",
                            type: "careplan_intent",
                        },
                        {
                            el: "#kategori_tindak_lanjut",
                            type: "careplan_category",
                        },
                        { el: "#dokter_kontrol", type: "doctor_dept" },
                        { el: "#estimasi_perawat", type: "nurse" },
                    ];

                    await Promise.all(
                        combos.map(({ el, type }) => {
                            const $el = $(el);
                            return AskepForm.showCombo(
                                $el,
                                "satusehat",
                                window.REGPID,
                                { type },
                            ).done(() => {
                                fillData($el);
                            });
                        }),
                    );

                    let codes = [];
                    let displays = [];
                    let codes_secondary = [];
                    let displays_secondary = [];
                    if (dataJSON) {
                        codes = dataJSON["icd10"] ?? codes;
                        displays = dataJSON["icd10_display"] ?? displays;
                        codes_secondary = dataJSON["icd10_secondary"] ?? [];
                        displays_secondary =
                            dataJSON["icd10_secondary_display"] ?? [];
                        if (
                            (codes.length > 0 && displays.length > 0) ||
                            (codes_secondary.length > 0 &&
                                displays_secondary.length > 0)
                        ) {
                            this.initializeICD10(codes, displays, true);
                            this.initializeICD10(
                                codes_secondary,
                                displays_secondary,
                                false,
                            );
                        } else {
                            $.ajax({
                                url: `${window.RELPATH}/modules/patient`,
                                data: {
                                    cmd: "getDataIcd",
                                    regpid: window.REGPID,
                                    mdl: "ICD10",
                                },
                                dataType: "JSON",
                                success: function (d) {
                                    if (d.success) {
                                        let primary = [];
                                        d.data.forEach((item) => {
                                            codes.push(item.kode);
                                            displays.push(item.nama);
                                            primary.push(item.is_utama);
                                        });
                                        this.initializeICD10(
                                            codes,
                                            displays,
                                            primary,
                                        );
                                    }
                                }.bind(this),
                            });
                        }
                    }
                },
                initializeICD10: function (
                    codes = [],
                    display = [],
                    flag = [],
                ) {
                    let primary = [];
                    let secondary = [];
                    codes.forEach((code, i) => {
                        (flag !== false &&
                        (flag[i] === "Utama" || flag === true || !flag[i])
                            ? primary
                            : secondary
                        ).push({
                            id: code,
                            text: display[i],
                        });
                    });
                    $.each(primary, function (i, item) {
                        $("#icd10").append(
                            new Option(item.text, item.id, true, true),
                        );
                    });
                    $.each(secondary, function (i, item) {
                        $("#icd10_secondary").append(
                            new Option(item.text, item.id, true, true),
                        );
                    });
                    $("#icd10").trigger("change");
                    SatusehatForm.DisplayInput.init($("#icd10"));
                    $("#icd10_secondary").trigger("change");
                    SatusehatForm.DisplayInput.init($("#icd10_secondary"));
                },
                initializeSelect2Row: function (
                    container,
                    medicationData = null,
                    options = {},
                ) {
                    container.find("td").each(function () {
                        let cell = $(this);
                        let selects = cell.find("select");
                        if (selects.length > 1) {
                            selects.not(":first").closest(".select").remove();
                        }
                    });

                    let namaObatContainer = container.find(
                        ".nama_obat_container",
                    );
                    namaObatContainer.empty();

                    const resolvedMedication =
                        medicationData && typeof medicationData === "object"
                            ? medicationData
                            : null;
                    const displayValue = hasEffectiveValue(
                        medicationData?.nama_obat_display,
                    )
                        ? medicationData.nama_obat_display
                        : (medicationData?.nama_obat ?? "");
                    const valueCandidate = hasEffectiveValue(
                        medicationData?.nama_obat,
                    )
                        ? medicationData.nama_obat
                        : hasEffectiveValue(medicationData?.value)
                          ? medicationData.value
                          : hasEffectiveValue(resolvedMedication?.id)
                            ? resolvedMedication.id
                            : "";
                    const medicationList = Array.isArray(
                        options?.medicationOptions,
                    )
                        ? options.medicationOptions.filter((item) =>
                              SatusehatForm.Medication.hasMeaningfulMedication(
                                  item,
                              ),
                          )
                        : [];
                    let matchedOption = null;
                    if (hasEffectiveValue(valueCandidate)) {
                        matchedOption =
                            medicationList.find((item) => {
                                const candidateValues = [
                                    item?.nama_obat,
                                    item?.id,
                                    item?.value,
                                    item?.text,
                                    item?.nama_obat_display,
                                ]
                                    .filter(hasEffectiveValue)
                                    .map(String);
                                return candidateValues.some(
                                    (candidate) =>
                                        candidate === String(valueCandidate),
                                );
                            }) || null;
                    }
                    if (!matchedOption && hasEffectiveValue(displayValue)) {
                        matchedOption =
                            medicationList.find((item) => {
                                const candidateValues = [
                                    item?.nama_obat_display,
                                    item?.text,
                                    item?.display,
                                    item?.nama_obat,
                                ]
                                    .filter(hasEffectiveValue)
                                    .map((candidate) =>
                                        candidate.toLowerCase(),
                                    );
                                return candidateValues.some(
                                    (candidate) =>
                                        candidate ===
                                        String(displayValue).toLowerCase(),
                                );
                            }) || null;
                    }
                    const medTypeValue = hasEffectiveValue(
                        medicationData?.med_type,
                    )
                        ? medicationData.med_type
                        : (matchedOption?.med_type ?? "");
                    const value = hasEffectiveValue(valueCandidate)
                        ? String(valueCandidate)
                        : matchedOption && hasEffectiveValue(matchedOption.id)
                          ? String(matchedOption.id)
                          : matchedOption &&
                              hasEffectiveValue(matchedOption.nama_obat)
                            ? String(matchedOption.nama_obat)
                            : "";
                    const effectiveDisplayValue = matchedOption
                        ? (matchedOption.nama_obat_display ??
                          matchedOption.text ??
                          matchedOption.nama_obat ??
                          displayValue ??
                          value ??
                          "")
                        : hasEffectiveValue(displayValue)
                          ? displayValue
                          : value || "";

                    const displayBlock = $("<div>", {
                        class: "nama_obat-display",
                        text: effectiveDisplayValue,
                        title: effectiveDisplayValue,
                    });
                    const hiddenValueInput = $("<input>", {
                        myid: "check_cara",
                        type: "hidden",
                        name: "nama_obat[]",
                        value: value,
                    });
                    const hiddenDisplayInput = $("<input>", {
                        myid: "check_cara",
                        type: "hidden",
                        name: "nama_obat_display[]",
                        value: effectiveDisplayValue,
                    });
                    const hiddenMedTypeInput = $("<input>", {
                        myid: "check_cara",
                        type: "hidden",
                        name: "med_type[]",
                        value: medTypeValue,
                    });
                    namaObatContainer
                        .append(displayBlock)
                        .append(hiddenValueInput)
                        .append(hiddenDisplayInput)
                        .append(hiddenMedTypeInput);

                    container.find("select.unit").each((i, el) => {
                        const $unit = $(el);
                        if (!$unit.data("select2")) {
                            $unit.select2({
                                width: "100%",
                                dropdownAutoWidth: true,
                            });
                        }
                        const selectedUnit = hasEffectiveValue(
                            resolvedMedication?.unit,
                        )
                            ? resolvedMedication.unit
                            : matchedOption &&
                                hasEffectiveValue(matchedOption.unit)
                              ? matchedOption.unit
                              : "";
                        SatusehatForm.Medication.applyUcumOptions($unit, {
                            selectedValue: selectedUnit,
                        }).fail(() => {
                            if (selectedUnit) {
                                $unit.val(selectedUnit);
                                if (
                                    $unit.hasClass("select2-hidden-accessible")
                                ) {
                                    $unit.trigger("change.select2");
                                } else {
                                    $unit.trigger("change");
                                }
                            }
                            SatusehatForm.DisplayInput.init($unit);
                        });
                    });
                },
            },

            /**
             * Manages hidden input fields for select2 elements to ensure proper data submission
             * @namespace DisplayInput
             * @description Handles the creation and updating of hidden input fields corresponding to select2 selections, ensuring that all necessary data attributes are submitted with the form.
             **/
            DisplayInput: {
                init: function (el = $(".select2")) {
                    $(el).each((i, el) => {
                        const $el = $(el);
                        const $container = $el.next();
                        if (typeof $el.attr("name") === "undefined") {
                            return;
                        }
                        function updateHiddenInputs() {
                            if (
                                $el.prop("disabled") &&
                                !["icd10", "icd10_secondary"].includes(
                                    $el.attr("id"),
                                )
                            ) {
                                return;
                            }
                            let selectedData = [];
                            if (
                                $el.hasClass("select2-hidden-accessible") &&
                                $el.data("select2")
                            ) {
                                selectedData = $el.select2("data") || [];
                            } else {
                                return;
                            }
                            if (!Array.isArray(selectedData)) {
                                selectedData = [selectedData];
                            }
                            $container
                                .find(`input[myid="check_cara"]`)
                                .remove();
                            selectedData.forEach((data) => {
                                if (!data) return;
                                const dataset = data?.element?.dataset ?? {};
                                for (let key in dataset) {
                                    const inputName = generateInputName(
                                        $el.attr("name"),
                                        key,
                                    );
                                    $container.append(
                                        `<input type="hidden" myid="check_cara" name="${inputName}" value="${dataset[key]}">`,
                                    );
                                }
                                if (!dataset.hasOwnProperty("display")) {
                                    const inputName = generateInputName(
                                        $el.attr("name"),
                                        "display",
                                    );
                                    $container.append(
                                        `<input type="hidden" myid="check_cara" name="${inputName}" value="${data?.text?.split(" - ")[1] ?? data.text}">`,
                                    );
                                }
                            });
                        }
                        $el.on(
                            "select2:select select2:unselect",
                            updateHiddenInputs,
                        );
                        updateHiddenInputs();
                    });

                    function generateInputName(name, key) {
                        if (name.endsWith("[]")) {
                            return name.slice(0, -2) + `_${key}[]`;
                        } else {
                            return name + `_${key}`;
                        }
                    }
                },
            },

            /**
             * Collapsible section functionalities
             * @namespace CollapsibleSections
             * @description Manages collapsible sections, including initial state based on input values, toggling visibility, and enabling/disabling contained inputs.
             **/
            CollapsibleSections: {
                init: function () {
                    const self = this;
                    $(".collapsible-content").each(function () {
                        self.initializeSection($(this));
                    });
                    $(".collapsible-trigger").on("click", function () {
                        const targetId = $(this).data("target");
                        if (!targetId) return;
                        const $section = $(targetId);
                        if (!$section.length) return;
                        const shouldOpen = !$section.is(":visible");
                        self.setSectionState($section, shouldOpen, {
                            trigger: $(this),
                            animate: true,
                            ensureValidation: shouldOpen,
                        });
                        if (
                            shouldOpen &&
                            $section.attr("id") === "section1-content"
                        ) {
                            const currentValue =
                                $("#pilih_riwayat").val() ||
                                RIWAYAT_OPTIONS.internal.value;
                            $("#pilih_riwayat").val(currentValue);
                            SatusehatForm.Medication.renderSelectionState(
                                currentValue,
                                { hydrate: true },
                            );
                            SatusehatForm.Medication.updateDisabledVisitInfo(
                                $("#pilih_riwayat_kunjungan_sebelumnya"),
                            );
                        }
                    });
                },
                initializeSection: function ($section) {
                    const $trigger = this.getTrigger($section);
                    this.setSectionState($section, false, {
                        trigger: $trigger,
                        animate: false,
                        force: true,
                    });

                    // Special handling for riwayat pengobatan section in create mode
                    if ($section.attr("id") === "section1-content") {
                        const isCreateMode =
                            (typeof dataJSON === "string" &&
                                isPlaceholderValue(dataJSON)) ||
                            (isPlainObject(dataJSON) &&
                                Object.keys(dataJSON).length === 0) ||
                            (isPlainObject(dataJSON) &&
                                Object.values(dataJSON).every(
                                    (val) =>
                                        val === null ||
                                        val === undefined ||
                                        val === "" ||
                                        (typeof val === "string" &&
                                            isPlaceholderValue(val)),
                                ));

                        if (isCreateMode) {
                            // Don't auto-open in create mode, regardless of field values
                            return;
                        }
                    }

                    if (
                        this.allowAutoOpen($section) &&
                        this.sectionHasValue($section)
                    ) {
                        this.setSectionState($section, true, {
                            trigger: $trigger,
                            animate: false,
                            ensureValidation: true,
                        });
                    }
                },
                getTrigger: function ($section) {
                    return $(
                        '[data-target="#' + $section.attr("id") + '"]',
                    ).first();
                },
                allowAutoOpen: function ($section) {
                    const autoOpenConfig = $section.data("auto-open");

                    // Special handling for riwayat pengobatan section in create mode
                    if ($section.attr("id") === "section1-content") {
                        // Check if we're in create mode (dataJSON is placeholder or empty)
                        const isCreateMode =
                            (typeof dataJSON === "string" &&
                                isPlaceholderValue(dataJSON)) ||
                            (isPlainObject(dataJSON) &&
                                Object.keys(dataJSON).length === 0) ||
                            (isPlainObject(dataJSON) &&
                                Object.values(dataJSON).every(
                                    (val) =>
                                        val === null ||
                                        val === undefined ||
                                        val === "" ||
                                        (typeof val === "string" &&
                                            isPlaceholderValue(val)),
                                ));

                        if (isCreateMode) {
                            return false; // Don't auto-open in create mode
                        }
                    }

                    return !(
                        autoOpenConfig === false || autoOpenConfig === "false"
                    );
                },
                sectionHasValue: function ($section) {
                    let hasValue = false;
                    $section
                        .find('input:not([type="hidden"]):not(.datepicker)')
                        .each(function () {
                            if ($(this).val()) {
                                hasValue = true;
                                return false;
                            }
                        });
                    if (!hasValue) {
                        $section.find("select").each(function () {
                            const val = $(this).val();
                            if (Array.isArray(val) ? val.length > 0 : val) {
                                hasValue = true;
                                return false;
                            }
                        });
                    }
                    if (!hasValue) {
                        $section.find("textarea").each(function () {
                            if ($(this).val()) {
                                hasValue = true;
                                return false;
                            }
                        });
                    }
                    return hasValue;
                },
                setSectionState: function ($section, open, options = {}) {
                    const {
                        trigger = null,
                        animate = true,
                        ensureValidation = false,
                        force = false,
                    } = options;
                    const isVisible = $section.is(":visible");
                    if (!force) {
                        if (open && isVisible) {
                            if (ensureValidation) {
                                this.validateSectionFields($section);
                            }
                            return;
                        }
                        if (!open && !isVisible) {
                            return;
                        }
                    }
                    const finalizeOpen = () => {
                        $section
                            .find("input, select, textarea")
                            .prop("disabled", false);
                        $section
                            .find('[data-is-mandatory="true"]')
                            .prop("required", true);
                        SatusehatForm.Datepicker.initWithin($section);
                        if (ensureValidation) {
                            this.validateSectionFields($section);
                        }
                        if (trigger && trigger.length) {
                            trigger.addClass("active");
                        }
                    };
                    const finalizeClose = () => {
                        $section
                            .find("input, select, textarea")
                            .prop("disabled", true);
                        $section
                            .find('[data-is-mandatory="true"]')
                            .prop("required", false);
                        $section.find(".is-invalid").each(function () {
                            removeValidation($(this));
                        });
                        if (trigger && trigger.length) {
                            trigger.removeClass("active");
                        }
                    };
                    if (open) {
                        if (animate) {
                            $section.stop(true, true).slideDown(finalizeOpen);
                        } else {
                            $section.show();
                            finalizeOpen();
                        }
                    } else {
                        if (animate) {
                            $section.stop(true, true).slideUp(finalizeClose);
                        } else {
                            $section.hide();
                            finalizeClose();
                        }
                    }
                },
                validateSectionFields: function ($section) {
                    $section
                        .find('[data-is-mandatory="true"]')
                        .each(function () {
                            validateField($(this));
                        });
                },
                refreshForField: function ($field) {
                    if (!$field || !$field.length) return;
                    const $section = $field.closest(".collapsible-content");
                    if (!$section.length) return;
                    if (!this.allowAutoOpen($section)) {
                        if ($section.is(":visible")) {
                            this.validateSectionFields($section);
                        }
                        return;
                    }
                    if (this.sectionHasValue($section)) {
                        const $trigger = this.getTrigger($section);
                        this.setSectionState($section, true, {
                            trigger: $trigger,
                            animate: false,
                            ensureValidation: true,
                        });
                    }
                },
            },

            /**
             * Medication-related functionalities
             * @namespace Medication
             * @description Handles medication selection, dynamic row addition/removal, and data population based on
             **/
            Medication: {
                visitMetadataCache: null,
                visitMetadataSource: null,
                pendingVisitSelection: null,
                isApplyingPendingVisit: false,
                internalOptionVisible: false,
                lastRenderedValue: null,
                lastRenderedHydrate: null,
                awaitingMetadataDefaults: false,
                currentMedications: [],
                medicationOptionsCache: {},
                ucumOptionsCache: {
                    loaded: false,
                    html: null,
                    promise: null,
                },
                collectOptionDataAttributes: function (option) {
                    const attributes = {};
                    if (!option || typeof option !== "object") {
                        return attributes;
                    }
                    const assignVariants = (rawKey, rawValue) => {
                        if (
                            !hasEffectiveValue(rawValue) ||
                            typeof rawKey !== "string"
                        ) {
                            return;
                        }
                        const trimmedKey = rawKey.trim();
                        if (!trimmedKey) {
                            return;
                        }
                        const baseKey = trimmedKey.replace(/[\s-]+/g, "_");
                        const snakeKey = baseKey.replace(/__+/g, "_");
                        const camelKey = snakeKey.replace(
                            /_+([a-z0-9])/g,
                            (_, chr) => chr.toUpperCase(),
                        );
                        const pascalKey =
                            camelKey.charAt(0).toUpperCase() +
                            camelKey.slice(1);
                        const lowercaseKey = snakeKey.toLowerCase();
                        const uppercaseKey = snakeKey.toUpperCase();
                        const variants = [
                            trimmedKey,
                            baseKey,
                            snakeKey,
                            camelKey,
                            pascalKey,
                            lowercaseKey,
                            uppercaseKey,
                        ];
                        variants.forEach((key) => {
                            if (key && typeof attributes[key] === "undefined") {
                                attributes[key] = rawValue;
                            }
                        });
                    };

                    if (option.attributes) {
                        Array.from(option.attributes).forEach((attr) => {
                            if (
                                !attr ||
                                !attr.name ||
                                !attr.name.startsWith("data-")
                            ) {
                                return;
                            }
                            assignVariants(attr.name.slice(5), attr.value);
                        });
                    }

                    const dataset = option.dataset || {};
                    Object.keys(dataset).forEach((key) => {
                        assignVariants(key, dataset[key]);
                    });

                    return attributes;
                },
                applyUcumOptions: function (selectEl, options = {}) {
                    const $select = $(selectEl);
                    if (!$select.length) {
                        return $.Deferred().resolve().promise();
                    }
                    const selectedValue = hasEffectiveValue(
                        options?.selectedValue,
                    )
                        ? String(options.selectedValue)
                        : "";
                    const cache = this.ucumOptionsCache;
                    const assignOptions = (html) => {
                        const normalizedHtml =
                            typeof html === "string" ? html : "";
                        const previousValue = selectedValue || $select.val();
                        const wasDisabled = $select.prop("disabled");
                        $select.html(normalizedHtml);
                        if (
                            previousValue &&
                            $select.find(`option[value="${previousValue}"]`)
                                .length
                        ) {
                            $select.val(previousValue);
                        } else if (selectedValue) {
                            $select.val(selectedValue);
                        }
                        $select.prop("disabled", wasDisabled);
                        if ($select.hasClass("select2-hidden-accessible")) {
                            $select.trigger("change.select2");
                        } else {
                            $select.trigger("change");
                        }
                        SatusehatForm.DisplayInput.init($select);
                    };

                    if (cache.loaded && cache.html !== null) {
                        assignOptions(cache.html);
                        return $.Deferred().resolve(cache.html).promise();
                    }

                    if (cache.promise) {
                        const chained = $.Deferred();
                        cache.promise
                            .done((html) => {
                                assignOptions(html);
                                chained.resolve(html);
                            })
                            .fail((error) => {
                                if (selectedValue) {
                                    $select.val(selectedValue);
                                    if (
                                        $select.hasClass(
                                            "select2-hidden-accessible",
                                        )
                                    ) {
                                        $select.trigger("change.select2");
                                    } else {
                                        $select.trigger("change");
                                    }
                                }
                                SatusehatForm.DisplayInput.init($select);
                                chained.reject(error);
                            });
                        return chained.promise();
                    }

                    const deferred = $.Deferred();
                    cache.promise = deferred.promise();

                    if (
                        !window.AskepForm ||
                        typeof AskepForm.showCombo !== "function"
                    ) {
                        cache.loaded = true;
                        cache.html = $select.html();
                        assignOptions(cache.html);
                        deferred.resolve(cache.html);
                        cache.promise = null;
                        return deferred.promise();
                    }

                    AskepForm.showCombo($select, "satusehat", window.REGPID, {
                        type: "ucum",
                    })
                        .done(() => {
                            cache.html = $select.html();
                            cache.loaded = true;
                            assignOptions(cache.html);
                            deferred.resolve(cache.html);
                        })
                        .fail((error) => {
                            if (window.console && console.warn) {
                                console.warn(
                                    "SatusehatForm.Medication.applyUcumOptions failed to load UCUM options",
                                    error,
                                );
                            }
                            if (selectedValue) {
                                $select.val(selectedValue);
                                if (
                                    $select.hasClass(
                                        "select2-hidden-accessible",
                                    )
                                ) {
                                    $select.trigger("change.select2");
                                } else {
                                    $select.trigger("change");
                                }
                            }
                            SatusehatForm.DisplayInput.init($select);
                            deferred.reject(error);
                        })
                        .always(() => {
                            cache.promise = null;
                        });

                    return deferred.promise();
                },
                createEmptyMedication: function () {
                    return {
                        nama_obat: "",
                        dosis: "",
                        frekuensi: "",
                        periode: "",
                        maksimal: "",
                        unit: "",
                        med_type: "",
                    };
                },
                hasMeaningfulMedication: function (med) {
                    if (!med || typeof med !== "object") {
                        return false;
                    }
                    const keys = [
                        "nama_obat",
                        "nama_obat_display",
                        "dosis",
                        "frekuensi",
                        "periode",
                        "maksimal",
                        "unit",
                        "med_type",
                    ];
                    return keys.some((key) => hasEffectiveValue(med[key]));
                },
                loadMedicationOptions: function (visitId = null) {
                    const cacheKey = this.getMedicationOptionsCacheKey(visitId);
                    const cached = this.medicationOptionsCache[cacheKey];
                    if (cached?.loaded) {
                        return $.Deferred().resolve(cached.options).promise();
                    }
                    if (cached?.promise) {
                        return cached.promise;
                    }
                    const deferred = $.Deferred();
                    const promise = deferred.promise();
                    const record = {
                        loaded: false,
                        options: [],
                        promise,
                    };
                    this.medicationOptionsCache[cacheKey] = record;

                    const targetRegpid = hasEffectiveValue(visitId)
                        ? String(visitId)
                        : window.REGPID;
                    const $select = $("<select>", {
                        style: "display:none;",
                    }).appendTo("body");
                    const self = this;

                    const bailOut = () => {
                        record.loaded = true;
                        record.options = [];
                        deferred.resolve([]);
                        record.promise = null;
                        $select.remove();
                        return promise;
                    };

                    const extractOptions = () => {
                        const options = [];
                        $select.find("option").each((_, option) => {
                            const value = option.value;
                            const text =
                                option.textContent || option.innerText || "";
                            if (
                                !hasEffectiveValue(value) &&
                                !hasEffectiveValue(text)
                            ) {
                                return;
                            }
                            const dataset =
                                self.collectOptionDataAttributes(option);
                            if (
                                !hasEffectiveValue(dataset.id) &&
                                hasEffectiveValue(value)
                            ) {
                                dataset.id = value;
                            }
                            if (
                                !hasEffectiveValue(dataset.value) &&
                                hasEffectiveValue(value)
                            ) {
                                dataset.value = value;
                            }
                            const medItem = Object.assign(
                                {
                                    id: hasEffectiveValue(value) ? value : "",
                                    value: hasEffectiveValue(value)
                                        ? value
                                        : "",
                                    text: text,
                                },
                                dataset,
                            );
                            if (
                                !hasEffectiveValue(medItem.nama_obat_display) &&
                                hasEffectiveValue(text)
                            ) {
                                medItem.nama_obat_display = text;
                            }
                            const normalized = self.normalizeMedicationItem(
                                medItem,
                                { defaults: medItem },
                            );
                            normalized.id = hasEffectiveValue(normalized.id)
                                ? String(normalized.id)
                                : hasEffectiveValue(value)
                                  ? String(value)
                                  : (normalized.nama_obat ?? "");
                            normalized.value = normalized.id;
                            normalized.nama_obat = hasEffectiveValue(
                                normalized.nama_obat,
                            )
                                ? normalized.nama_obat
                                : normalized.id;
                            normalized.nama_obat_display = hasEffectiveValue(
                                normalized.nama_obat_display,
                            )
                                ? normalized.nama_obat_display
                                : hasEffectiveValue(text)
                                  ? text
                                  : (normalized.nama_obat ?? normalized.id);
                            normalized.text = normalized.nama_obat_display;
                            normalized.sourceDataset = Object.assign(
                                {},
                                dataset,
                            );
                            options.push(normalized);
                        });
                        return options;
                    };

                    if (
                        !window.AskepForm ||
                        typeof AskepForm.showCombo !== "function"
                    ) {
                        bailOut();
                        return promise;
                    }

                    AskepForm.showCombo($select, "satusehat", targetRegpid, {
                        type: "medication",
                    })
                        .done(() => {
                            const options = extractOptions();
                            record.loaded = true;
                            record.options = options;
                            deferred.resolve(options);
                        })
                        .fail((error) => {
                            record.loaded = false;
                            record.options = [];
                            deferred.reject(error);
                        })
                        .always(() => {
                            record.promise = null;
                            $select.remove();
                        });

                    return promise;
                },
                getMedicationOptionsCacheKey: function (visitId) {
                    return hasEffectiveValue(visitId)
                        ? String(visitId)
                        : "__default__";
                },
                getMedicationOptionsForVisit: function (visitId) {
                    const cacheKey = this.getMedicationOptionsCacheKey(visitId);
                    return (
                        (this.medicationOptionsCache[cacheKey] &&
                            this.medicationOptionsCache[cacheKey].options) ||
                        []
                    );
                },
                resolveValue: function (source, keys, fallback = "") {
                    if (!source || typeof source !== "object") {
                        return fallback;
                    }
                    for (const key of keys) {
                        if (hasEffectiveValue(source[key])) {
                            return source[key];
                        }
                        const camelKey = key.replace(/_([a-z])/g, (_, chr) =>
                            chr.toUpperCase(),
                        );
                        if (
                            camelKey !== key &&
                            hasEffectiveValue(source[camelKey])
                        ) {
                            return source[camelKey];
                        }
                        const upperKey = key.toUpperCase();
                        if (
                            upperKey !== key &&
                            hasEffectiveValue(source[upperKey])
                        ) {
                            return source[upperKey];
                        }
                    }
                    return fallback;
                },
                coerceArray: function (value) {
                    if (Array.isArray(value)) {
                        return value;
                    }
                    if (typeof value === "string") {
                        const trimmed = value.trim();
                        if (!trimmed) {
                            return [];
                        }
                        try {
                            const parsed = JSON.parse(trimmed);
                            if (Array.isArray(parsed)) {
                                return parsed;
                            }
                            if (isPlainObject(parsed)) {
                                return Object.values(parsed);
                            }
                        } catch (error) {
                            return [trimmed];
                        }
                        return [trimmed];
                    }
                    if (isPlainObject(value)) {
                        return Object.values(value);
                    }
                    if (
                        typeof value === "number" ||
                        typeof value === "boolean"
                    ) {
                        return [value];
                    }
                    return [];
                },
                sanitizeMedicationField: function (value) {
                    if (value === null || value === undefined) {
                        return "";
                    }
                    if (typeof value === "number") {
                        if (Number.isNaN(value)) {
                            return "";
                        }
                        return String(value);
                    }
                    if (typeof value === "boolean") {
                        return value ? "true" : "false";
                    }
                    if (typeof value === "string") {
                        return value.trim();
                    }
                    return String(value).trim();
                },
                normalizeMedicationItem: function (item = {}, context = {}) {
                    const defaults = context?.defaults ?? {};
                    const resolvedName = this.sanitizeMedicationField(
                        this.resolveValue(
                            item,
                            [
                                "nama_obat",
                                "namaObat",
                                "name",
                                "label",
                                "title",
                                "text",
                                "obat",
                                "medication",
                                "medication_name",
                                "medicationName",
                            ],
                            defaults.nama_obat ?? "",
                        ),
                    );
                    const resolvedDisplay = this.sanitizeMedicationField(
                        this.resolveValue(
                            item,
                            [
                                "nama_obat_display",
                                "namaObatDisplay",
                                "display",
                                "text_display",
                                "textDisplay",
                                "label",
                                "text",
                            ],
                            defaults.nama_obat_display ?? resolvedName,
                        ),
                    );
                    const resolvedDose = this.sanitizeMedicationField(
                        this.resolveValue(
                            item,
                            [
                                "dosis",
                                "dose",
                                "dosage",
                                "dosing",
                                "strength",
                                "jumlah_dosis",
                                "jumlahDosis",
                            ],
                            defaults.dosis ?? "",
                        ),
                    );
                    const resolvedFrequency = this.sanitizeMedicationField(
                        this.resolveValue(
                            item,
                            [
                                "frekuensi",
                                "frequency",
                                "freq",
                                "jumlah_frekuensi",
                                "jumlahFrekuensi",
                            ],
                            defaults.frekuensi ?? "",
                        ),
                    );
                    const resolvedPeriod = this.sanitizeMedicationField(
                        this.resolveValue(
                            item,
                            ["periode", "period", "duration", "durasi"],
                            defaults.periode ?? "",
                        ),
                    );
                    const resolvedMax = this.sanitizeMedicationField(
                        this.resolveValue(
                            item,
                            [
                                "maksimal",
                                "maximum",
                                "max",
                                "maximal",
                                "maxDose",
                            ],
                            defaults.maksimal ?? "",
                        ),
                    );
                    const resolvedUnit = this.sanitizeMedicationField(
                        this.resolveValue(
                            item,
                            [
                                "unit",
                                "unit_code",
                                "unitCode",
                                "satuan",
                                "measurement_unit",
                                "measurementUnit",
                                "ucum",
                            ],
                            defaults.unit ?? "",
                        ),
                    );
                    const resolvedType = this.sanitizeMedicationField(
                        this.resolveValue(
                            item,
                            [
                                "med_type",
                                "medType",
                                "jenis",
                                "type",
                                "category",
                                "medication_type",
                                "medicationType",
                            ],
                            defaults.med_type ?? "",
                        ),
                    );
                    const resolvedId = this.sanitizeMedicationField(
                        this.resolveValue(
                            item,
                            [
                                "id",
                                "value",
                                "kode",
                                "code",
                                "uuid",
                                "medication_id",
                                "medicationId",
                                "resource_id",
                                "resourceId",
                            ],
                            defaults.id ?? resolvedName,
                        ),
                    );
                    return {
                        id: resolvedId || resolvedName,
                        nama_obat: resolvedName,
                        nama_obat_display: resolvedDisplay || resolvedName,
                        dosis: resolvedDose,
                        frekuensi: resolvedFrequency,
                        periode: resolvedPeriod,
                        maksimal: resolvedMax,
                        unit: resolvedUnit,
                        med_type: resolvedType,
                    };
                },
                extractMedicationsFromParallelArrays: function (container) {
                    if (!container || typeof container !== "object") {
                        return [];
                    }
                    const nameSources = [
                        container?.nama_obat,
                        container?.namaObat,
                        container?.obat,
                        container?.medication_name,
                        container?.medicationName,
                    ];
                    let names = [];
                    for (const source of nameSources) {
                        names = this.coerceArray(source);
                        if (names.length) {
                            break;
                        }
                    }
                    if (!names.length) {
                        return [];
                    }
                    const displays = this.coerceArray(
                        container?.nama_obat_display ??
                            container?.namaObatDisplay ??
                            container?.obat_display ??
                            container?.display_obat ??
                            container?.medication_display ??
                            container?.medicationDisplay ??
                            container?.display,
                    );
                    const dosis = this.coerceArray(
                        container?.dosis ?? container?.dose ?? container?.doses,
                    );
                    const frekuensi = this.coerceArray(
                        container?.frekuensi ??
                            container?.frequency ??
                            container?.freq,
                    );
                    const periode = this.coerceArray(
                        container?.periode ??
                            container?.period ??
                            container?.duration ??
                            container?.durasi,
                    );
                    const maksimal = this.coerceArray(
                        container?.maksimal ??
                            container?.maximum ??
                            container?.max ??
                            container?.maxDose,
                    );
                    const unit = this.coerceArray(
                        container?.unit ??
                            container?.satuan ??
                            container?.measurement_unit ??
                            container?.measurementUnit ??
                            container?.ucum,
                    );
                    const medType = this.coerceArray(
                        container?.med_type ??
                            container?.medType ??
                            container?.jenis ??
                            container?.type ??
                            container?.category ??
                            container?.medication_type ??
                            container?.medicationType,
                    );

                    return names
                        .map((name, idx) => {
                            const defaults = {
                                id: name,
                                nama_obat: name,
                                nama_obat_display: displays[idx] ?? "",
                                dosis: dosis[idx] ?? "",
                                frekuensi: frekuensi[idx] ?? "",
                                periode: periode[idx] ?? "",
                                maksimal: maksimal[idx] ?? "",
                                unit: unit[idx] ?? "",
                                med_type: medType[idx] ?? "",
                            };
                            return this.normalizeMedicationItem(
                                {},
                                { defaults },
                            );
                        })
                        .filter((med) => this.hasMeaningfulMedication(med));
                },
                dedupeMedications: function (medications) {
                    const seen = new Set();
                    const result = [];
                    medications.forEach((med) => {
                        if (!med || typeof med !== "object") {
                            return;
                        }
                        const key = [
                            med.nama_obat ?? "",
                            med.nama_obat_display ?? "",
                            med.dosis ?? "",
                            med.frekuensi ?? "",
                            med.periode ?? "",
                            med.maksimal ?? "",
                            med.unit ?? "",
                            med.med_type ?? "",
                        ].join("||");
                        if (!seen.has(key)) {
                            seen.add(key);
                            result.push(med);
                        }
                    });
                    return result;
                },
                extractMedicationsFromEntry: function (entry, visited) {
                    if (!entry || typeof entry !== "object") {
                        return [];
                    }
                    if (!visited) {
                        visited = new WeakSet();
                    }
                    if (visited.has(entry)) {
                        return [];
                    }
                    visited.add(entry);

                    let meds = [];
                    const listProps = [
                        "meds",
                        "medications",
                        "medication",
                        "detail_obat",
                        "detailObat",
                        "obat_list",
                        "obatList",
                        "obats",
                        "data_obat",
                        "dataObat",
                        "items",
                        "entries",
                    ];
                    listProps.forEach((prop) => {
                        const rawList = entry[prop];
                        const arr = this.coerceArray(rawList);
                        if (!arr.length) {
                            return;
                        }
                        arr.forEach((item) => {
                            if (item && typeof item === "string") {
                                try {
                                    const parsed = JSON.parse(item);
                                    if (parsed && typeof parsed === "object") {
                                        item = parsed;
                                    }
                                } catch (error) {
                                    item = { nama_obat: item };
                                }
                            }
                            const normalized = this.normalizeMedicationItem(
                                item ?? {},
                            );
                            if (this.hasMeaningfulMedication(normalized)) {
                                meds.push(normalized);
                            }
                        });
                    });

                    const fromParallel =
                        this.extractMedicationsFromParallelArrays(entry);
                    fromParallel.forEach((item) => meds.push(item));

                    const skipKeys = new Set([
                        ...listProps,
                        "nama_obat",
                        "namaObat",
                        "nama_obat_display",
                        "namaObatDisplay",
                        "med_type",
                        "medType",
                        "dosis",
                        "dose",
                        "doses",
                        "frekuensi",
                        "frequency",
                        "freq",
                        "periode",
                        "period",
                        "duration",
                        "durasi",
                        "maksimal",
                        "maximum",
                        "max",
                        "maximal",
                        "maxDose",
                        "unit",
                        "satuan",
                        "measurement_unit",
                        "measurementUnit",
                        "ucum",
                        "unit_display",
                        "unitDisplay",
                        "nama_obat_display",
                        "namaObatDisplay",
                        "med_type_display",
                        "medTypeDisplay",
                    ]);

                    const shouldSkipKey = (key) => {
                        if (!key) {
                            return true;
                        }
                        if (skipKeys.has(key)) {
                            return true;
                        }
                        const lowerKey = String(key).toLowerCase();
                        if (
                            lowerKey.endsWith("_display") ||
                            lowerKey.endsWith("_txt") ||
                            lowerKey.endsWith("_text") ||
                            lowerKey.endsWith("_type") ||
                            lowerKey.endsWith("_types") ||
                            lowerKey.endsWith("_unit") ||
                            lowerKey.includes("unit_display") ||
                            lowerKey.includes("unitlabel") ||
                            lowerKey.includes("unitdescription") ||
                            lowerKey.includes("med_type")
                        ) {
                            return true;
                        }
                        return false;
                    };

                    Object.keys(entry).forEach((key) => {
                        if (shouldSkipKey(key)) {
                            return;
                        }
                        if (listProps.includes(key)) {
                            return;
                        }
                        const value = entry[key];
                        if (Array.isArray(value)) {
                            value.forEach((item) => {
                                if (item && typeof item === "string") {
                                    try {
                                        const parsed = JSON.parse(item);
                                        if (
                                            parsed &&
                                            typeof parsed === "object"
                                        ) {
                                            meds.push(
                                                ...this.extractMedicationsFromEntry(
                                                    parsed,
                                                    visited,
                                                ),
                                            );
                                        }
                                    } catch (error) {
                                        const normalized =
                                            this.normalizeMedicationItem({
                                                nama_obat: item,
                                            });
                                        if (
                                            this.hasMeaningfulMedication(
                                                normalized,
                                            )
                                        ) {
                                            meds.push(normalized);
                                        }
                                    }
                                    return;
                                }
                                if (item && typeof item === "object") {
                                    meds.push(
                                        ...this.extractMedicationsFromEntry(
                                            item,
                                            visited,
                                        ),
                                    );
                                }
                            });
                        } else if (value && typeof value === "string") {
                            if (
                                value.trim().startsWith("{") ||
                                value.trim().startsWith("[")
                            ) {
                                try {
                                    const parsed = JSON.parse(value);
                                    if (parsed && typeof parsed === "object") {
                                        meds.push(
                                            ...this.extractMedicationsFromEntry(
                                                parsed,
                                                visited,
                                            ),
                                        );
                                    }
                                } catch (error) {
                                    // noop
                                }
                            }
                        } else if (value && typeof value === "object") {
                            meds.push(
                                ...this.extractMedicationsFromEntry(
                                    value,
                                    visited,
                                ),
                            );
                        }
                    });

                    return this.dedupeMedications(meds);
                },
                renderSelectionState: function (value = "", options = {}) {
                    const hydrate = options?.hydrate !== false;
                    const $riwayatSelect = $("#pilih_riwayat");
                    const $internalContainer = $("#internal-visit-container");
                    const $medicationContainer = $("#medication-container");
                    const $disabledInfo = $("#disabled-visit-info");

                    if (
                        !value &&
                        $riwayatSelect.length &&
                        this.internalOptionVisible
                    ) {
                        const hasInternalOption =
                            $riwayatSelect.find(
                                `option[value="${RIWAYAT_OPTIONS.internal.value}"]`,
                            ).length > 0;
                        if (hasInternalOption) {
                            value = RIWAYAT_OPTIONS.internal.value;
                            $riwayatSelect.val(value);
                            if (isPlainObject(dataJSON)) {
                                dataJSON["pilih_riwayat"] = value;
                            }
                        }
                    }
                    const isInternal = value === RIWAYAT_OPTIONS.internal.value;
                    this.clearFieldValidation($riwayatSelect);
                    if (!isInternal) {
                        $internalContainer.hide();
                        $medicationContainer.hide();
                        if ($disabledInfo.length) {
                            $disabledInfo.hide();
                        }
                        this.lastRenderedValue = value;
                        this.lastRenderedHydrate = hydrate;
                        return;
                    }

                    $internalContainer.show();

                    if (
                        hydrate &&
                        this.lastRenderedValue === value &&
                        this.lastRenderedHydrate
                    ) {
                        this.updateDisabledVisitInfo(
                            $("#pilih_riwayat_kunjungan_sebelumnya"),
                        );
                        this.lastRenderedValue = value;
                        this.lastRenderedHydrate = hydrate;
                        return;
                    }

                    if (!hydrate) {
                        this.clearVisitSelectValidation(
                            $("#pilih_riwayat_kunjungan_sebelumnya"),
                        );
                        this.lastRenderedValue = value;
                        this.lastRenderedHydrate = hydrate;
                        return;
                    }

                    const rksebelum = $("#pilih_riwayat_kunjungan_sebelumnya");
                    AskepForm.showCombo(rksebelum, "satusehat", window.REGPID, {
                        type: "visit_history",
                        pid: window.PID,
                    })
                        .done(() => {
                            if (!initialized) {
                                fillData(rksebelum, "", null, false);
                                SatusehatForm.Medication.handleRiwayatKunjunganSebelumnyaChange(
                                    rksebelum.get(0),
                                );
                            }
                            SatusehatForm.Medication.ingestVisitOptions(
                                rksebelum,
                            );
                            SatusehatForm.Medication.postVisitOptionsInit();
                            if (
                                !initialized ||
                                SatusehatForm.Medication
                                    .awaitingMetadataDefaults
                            ) {
                                SatusehatForm.Medication.initializeDefaults({
                                    skipRender: true,
                                });
                                SatusehatForm.Medication.primeRiwayatOptions({
                                    skipRender: true,
                                });
                            }
                            SatusehatForm.Medication.clearVisitSelectValidation(
                                rksebelum,
                            );
                            if (!hasEffectiveValue(rksebelum.val())) {
                                validateField(rksebelum);
                            }
                        })
                        .fail(() => {
                            SatusehatForm.Medication.handleEmptyVisitHistory(
                                rksebelum,
                            );
                            SatusehatForm.Medication.clearVisitSelectValidation(
                                rksebelum,
                            );
                        });

                    validateField($riwayatSelect);

                    this.lastRenderedValue = value;
                    this.lastRenderedHydrate = hydrate;
                },
                isVisitMetadataReady: function () {
                    return this.visitMetadataSource !== null;
                },
                clearFieldValidation: function ($field) {
                    if (!$field || !$field.length) {
                        return;
                    }
                    removeValidation($field);
                    const $formGroup = $field.closest(".form-group");
                    if ($formGroup.length) {
                        $formGroup.find(".invalid-feedback").remove();
                        $formGroup
                            .find(".select2-selection")
                            .removeClass("is-invalid");
                        $formGroup
                            .find(".select2, .select2-container")
                            .removeClass("is-invalid");
                        $formGroup
                            .find(".is-invalid")
                            .removeClass("is-invalid");
                    }
                },
                clearVisitSelectValidation: function ($select) {
                    if (!$select || !$select.length) {
                        return;
                    }
                    this.clearFieldValidation($select);
                    setTimeout(() => {
                        this.clearFieldValidation($select);
                    }, 0);
                },
                handleEmptyVisitHistory: function ($select) {
                    if (!$select || !$select.length) {
                        return;
                    }
                    $select.empty().append("<option></option>");
                    $select.prop("disabled", false);
                    if ($select.hasClass("select2-hidden-accessible")) {
                        $select.val("").trigger("change.select2");
                    } else {
                        $select.val("").trigger("change");
                    }
                    this.updateDisabledVisitInfo($select, { forceHide: true });
                    this.visitMetadataCache = [];
                    this.visitMetadataSource = null;
                    this.pendingVisitSelection = null;
                    this.currentMedications = [];
                    this.handleAddMedicationRow([], { visitId: null });
                    this.hideVisitSelection();
                },
                normalizeVisitEntry: function (visit, order = 0) {
                    if (!visit) {
                        return null;
                    }
                    const rawOptionData = visit?.raw?.optionData ?? {};
                    const idCandidate =
                        visit?.id ??
                        visit?.visit_id ??
                        visit?.regpid ??
                        visit?.REGPID ??
                        visit?.value ??
                        visit?.kode ??
                        visit?.code ??
                        visit?.identifier ??
                        visit?.ID ??
                        null;
                    const id =
                        idCandidate !== undefined && idCandidate !== null
                            ? String(idCandidate)
                            : "";
                    if (!id) {
                        return null;
                    }
                    const hasMedicationRaw =
                        visit?.has_medication ??
                        visit?.is_medication ??
                        visit?.IS_MEDICATION ??
                        visit?.hasMedication ??
                        visit?.medication;
                    const sentMedicationRaw =
                        visit?.sent_medication ??
                        visit?.SENT_MEDICATION ??
                        visit?.sentMedication ??
                        visit?.is_sent_medication ??
                        visit?.sent;

                    let hasMedication = true;
                    if (
                        typeof hasMedicationRaw === "boolean" ||
                        typeof hasMedicationRaw === "number"
                    ) {
                        hasMedication = toBoolean(hasMedicationRaw);
                    } else if (typeof hasMedicationRaw === "string") {
                        const trimmed = hasMedicationRaw.trim();
                        if (trimmed && !isPlaceholderValue(trimmed)) {
                            hasMedication = toBoolean(trimmed);
                        }
                    } else if (
                        hasMedicationRaw !== undefined &&
                        hasMedicationRaw !== null
                    ) {
                        hasMedication = toBoolean(hasMedicationRaw);
                    }

                    let sentMedication = false;
                    if (
                        typeof sentMedicationRaw === "boolean" ||
                        typeof sentMedicationRaw === "number"
                    ) {
                        sentMedication = toBoolean(sentMedicationRaw);
                    } else if (typeof sentMedicationRaw === "string") {
                        const trimmedSent = sentMedicationRaw.trim();
                        if (trimmedSent && !isPlaceholderValue(trimmedSent)) {
                            sentMedication = toBoolean(trimmedSent);
                        }
                    } else if (
                        sentMedicationRaw !== undefined &&
                        sentMedicationRaw !== null
                    ) {
                        sentMedication = toBoolean(sentMedicationRaw);
                    }

                    const createdAtRaw =
                        visit?.tanggal ??
                        visit?.created_at ??
                        visit?.updated_at ??
                        visit?.waktu ??
                        visit?.datetime ??
                        visit?.createdAt ??
                        visit?.updatedAt ??
                        visit?.DATE ??
                        visit?.date;

                    const createdAt =
                        createdAtRaw &&
                        !isPlaceholderValue(String(createdAtRaw).trim())
                            ? parseDateValue(createdAtRaw)
                            : null;

                    const resourceIdRaw =
                        visit?.resource_id ??
                        visit?.resourceId ??
                        visit?.RESOURCE_ID ??
                        visit?.resource ??
                        visit?.RESOURCE ??
                        visit?.raw?.resource_id ??
                        visit?.raw?.resourceId ??
                        rawOptionData?.resource_id ??
                        rawOptionData?.resourceId ??
                        rawOptionData?.resource ??
                        rawOptionData?.uuid;

                    const resourceId =
                        resourceIdRaw &&
                        !isPlaceholderValue(String(resourceIdRaw).trim())
                            ? String(resourceIdRaw).trim()
                            : "";

                    return {
                        id,
                        order: typeof order === "number" ? order : 0,
                        hasMedication,
                        sentMedication,
                        createdAt,
                        resourceId,
                        raw: visit,
                    };
                },
                normalizeVisitCollection: function (source) {
                    const visitArray = toArray(source);
                    if (!Array.isArray(visitArray)) {
                        return [];
                    }
                    return visitArray
                        .map((visit, index) =>
                            this.normalizeVisitEntry(visit, index),
                        )
                        .filter(Boolean);
                },
                ingestVisitOptions: function ($select) {
                    if (!$select || !$select.length) {
                        return;
                    }
                    const metadataMap = new Map();
                    const existing = Array.isArray(this.visitMetadataCache)
                        ? this.visitMetadataCache
                        : [];
                    existing.forEach((visit) => {
                        if (visit && visit.id) {
                            metadataMap.set(String(visit.id), visit);
                        }
                    });

                    $select.find("option").each((index, option) => {
                        const value = option.value;
                        if (!value) {
                            return;
                        }
                        const dataset = option.dataset || {};
                        const existingMeta = metadataMap.get(String(value));
                        const order =
                            typeof existingMeta?.order === "number"
                                ? existingMeta.order
                                : index;

                        const attrHasMedication =
                            dataset.hasMedication ??
                            dataset.has_medication ??
                            dataset.isMedication ??
                            dataset.is_medication ??
                            dataset.medication ??
                            option.getAttribute("data-has-medication") ??
                            option.getAttribute("data-has_medication") ??
                            option.getAttribute("data-is-medication") ??
                            option.getAttribute("data-is_medication") ??
                            option.getAttribute("data-medication");

                        const attrSentMedication =
                            dataset.sentMedication ??
                            dataset.sent_medication ??
                            dataset.isSentMedication ??
                            dataset.is_sent_medication ??
                            dataset.sent ??
                            option.getAttribute("data-sent-medication") ??
                            option.getAttribute("data-sent_medication") ??
                            option.getAttribute("data-is-sent-medication") ??
                            option.getAttribute("data-is_sent_medication");

                        const attrCreatedAt =
                            dataset.tanggal ??
                            dataset.createdAt ??
                            dataset.created_at ??
                            dataset.updatedAt ??
                            dataset.updated_at ??
                            dataset.datetime ??
                            dataset.date ??
                            dataset.waktu ??
                            option.getAttribute("data-created-at") ??
                            option.getAttribute("data-created_at") ??
                            option.getAttribute("data-tanggal") ??
                            option.getAttribute("data-date");

                        const attrResourceId =
                            dataset.resourceId ??
                            dataset.resource_id ??
                            dataset.resource ??
                            dataset.uuid ??
                            option.getAttribute("data-resource-id") ??
                            option.getAttribute("data-resource_id") ??
                            option.getAttribute("data-resource");

                        const rawVisit = {
                            id: value,
                            has_medication: attrHasMedication,
                            sent_medication: attrSentMedication,
                            resource_id: attrResourceId,
                            tanggal: attrCreatedAt,
                            raw: {
                                optionData: Object.assign({}, dataset),
                            },
                        };

                        const normalized = this.normalizeVisitEntry(
                            rawVisit,
                            order,
                        );
                        if (!normalized) {
                            return;
                        }
                        if (existingMeta) {
                            const merged = Object.assign({}, existingMeta);
                            if (typeof normalized.hasMedication === "boolean") {
                                merged.hasMedication = normalized.hasMedication;
                            }
                            if (
                                typeof normalized.sentMedication === "boolean"
                            ) {
                                merged.sentMedication =
                                    normalized.sentMedication;
                            }
                            if (normalized.createdAt) {
                                merged.createdAt = normalized.createdAt;
                            }
                            if (normalized.resourceId) {
                                merged.resourceId = normalized.resourceId;
                            }
                            merged.raw = Object.assign(
                                {},
                                existingMeta.raw,
                                normalized.raw,
                            );
                            metadataMap.set(normalized.id, merged);
                        } else {
                            metadataMap.set(normalized.id, normalized);
                        }
                    });

                    const metadata = Array.from(metadataMap.values()).sort(
                        (a, b) => {
                            const orderA =
                                typeof a.order === "number" ? a.order : 0;
                            const orderB =
                                typeof b.order === "number" ? b.order : 0;
                            if (orderA === orderB) {
                                return String(a.id).localeCompare(String(b.id));
                            }
                            return orderA - orderB;
                        },
                    );

                    this.visitMetadataCache = metadata;
                    this.visitMetadataSource = "options";
                },
                primeRiwayatOptions: function (options = {}) {
                    const skipRender = options?.skipRender === true;
                    const $riwayatSelect = $("#pilih_riwayat");
                    const metadataReady = this.isVisitMetadataReady();

                    this.enableInternalOption({ skipRefresh: true });

                    if (!metadataReady) {
                        if (!$riwayatSelect.val()) {
                            $riwayatSelect.val(RIWAYAT_OPTIONS.internal.value);
                            if (isPlainObject(dataJSON)) {
                                dataJSON["pilih_riwayat"] =
                                    RIWAYAT_OPTIONS.internal.value;
                            }
                        }
                        const defaultMeds = this.getDefaultMedications();
                        this.currentMedications = defaultMeds;
                        this.handleAddMedicationRow(defaultMeds, {
                            visitId: null,
                        });
                        if (!skipRender) {
                            this.renderSelectionState($riwayatSelect.val(), {
                                hydrate: false,
                            });
                        }
                        return;
                    }

                    const visits = this.getVisitMetadata();
                    const hasMedicationVisits = visits.some(
                        (visit) => visit.hasMedication || visit.sentMedication,
                    );
                    if (!hasMedicationVisits) {
                        if (!$riwayatSelect.val()) {
                            $riwayatSelect.val(RIWAYAT_OPTIONS.internal.value);
                            if (isPlainObject(dataJSON)) {
                                dataJSON["pilih_riwayat"] =
                                    RIWAYAT_OPTIONS.internal.value;
                            }
                        }
                        const defaultMeds = this.getDefaultMedications();
                        this.currentMedications = defaultMeds;
                        this.handleAddMedicationRow(defaultMeds, {
                            visitId: null,
                        });
                        if (!skipRender) {
                            this.renderSelectionState($riwayatSelect.val(), {
                                hydrate: false,
                            });
                        }
                        return;
                    }

                    if (!$riwayatSelect.val()) {
                        $riwayatSelect.val(RIWAYAT_OPTIONS.internal.value);
                        if (isPlainObject(dataJSON)) {
                            dataJSON["pilih_riwayat"] =
                                RIWAYAT_OPTIONS.internal.value;
                        }
                    }

                    if (!skipRender) {
                        this.renderSelectionState($riwayatSelect.val(), {
                            hydrate: false,
                        });
                    }
                },
                addOption: function ($select, spec, beforeValue = null) {
                    if ($select.find(`option[value="${spec.value}"]`).length) {
                        return false;
                    }
                    const option = new Option(
                        spec.label,
                        spec.value,
                        false,
                        false,
                    );
                    if (beforeValue) {
                        const beforeOption = $select
                            .find(`option[value="${beforeValue}"]`)
                            .get(0);
                        if (beforeOption) {
                            $select[0].add(option, beforeOption);
                            return true;
                        }
                    }
                    $select.append(option);
                    return true;
                },
                removeOption: function ($select, value) {
                    const $option = $select.find(`option[value="${value}"]`);
                    if ($option.length) {
                        $option.remove();
                        return true;
                    }
                    return false;
                },
                initializeDefaults: function (options = {}) {
                    const skipRender = options?.skipRender === true;
                    const $riwayatSelect = $("#pilih_riwayat");
                    const $visitSelect = $(
                        "#pilih_riwayat_kunjungan_sebelumnya",
                    );
                    const metadataReady = this.isVisitMetadataReady();
                    const visits = this.getVisitMetadata();
                    const visitsWithMedicationFlag = Array.isArray(visits)
                        ? visits.filter((visit) => {
                              if (!visit) {
                                  return false;
                              }
                              if (visit.hasMedication || visit.sentMedication) {
                                  return true;
                              }
                              if (!hasEffectiveValue(visit.id)) {
                                  return false;
                              }
                              const medsForVisit = this.getMedicationsForVisit(
                                  visit.id,
                                  { fallback: false },
                              );
                              return (
                                  Array.isArray(medsForVisit) &&
                                  medsForVisit.length > 0
                              );
                          })
                        : [];
                    const initialVisitId =
                        this.resolveInitialVisitIdFromData(visits);

                    if (!$riwayatSelect.val()) {
                        $riwayatSelect.val(RIWAYAT_OPTIONS.internal.value);
                        if (isPlainObject(dataJSON)) {
                            dataJSON["pilih_riwayat"] =
                                RIWAYAT_OPTIONS.internal.value;
                        }
                    }

                    this.enableInternalOption({ skipRefresh: true });

                    const applyVisitVisibility = (shouldHide) => {
                        if (shouldHide) {
                            this.hideVisitSelection();
                        } else {
                            this.showVisitSelection();
                        }
                    };

                    const totalVisitCount = Array.isArray(visits)
                        ? visits.length
                        : 0;
                    const shouldHideVisitSelect =
                        metadataReady && totalVisitCount === 0;

                    if (initialVisitId) {
                        this.awaitingMetadataDefaults = !metadataReady;
                        this.pendingVisitSelection = initialVisitId;
                        const meds =
                            this.getMedicationsForVisit(initialVisitId);
                        this.currentMedications = meds;
                        this.handleAddMedicationRow(meds, {
                            visitId: initialVisitId,
                        });

                        if ($visitSelect.length) {
                            this.isApplyingPendingVisit = true;
                            $visitSelect.val(initialVisitId);
                            this.isApplyingPendingVisit = false;
                        }

                        applyVisitVisibility(shouldHideVisitSelect);
                        this.renderSelectionState($riwayatSelect.val(), {
                            hydrate: !skipRender,
                        });

                        if (metadataReady) {
                            this.updateDisabledVisitInfo($visitSelect);
                        } else {
                            this.updateDisabledVisitInfo($visitSelect, {
                                forceHide: true,
                            });
                        }
                        return;
                    }

                    applyVisitVisibility(shouldHideVisitSelect);

                    if (!metadataReady) {
                        this.awaitingMetadataDefaults = true;
                        const defaultMeds = this.getDefaultMedications();
                        this.currentMedications = defaultMeds;
                        this.handleAddMedicationRow(defaultMeds, {
                            visitId: null,
                        });
                        this.renderSelectionState($riwayatSelect.val(), {
                            hydrate: !skipRender,
                        });
                        return;
                    }

                    this.awaitingMetadataDefaults = false;

                    const hasMedicationVisits =
                        visitsWithMedicationFlag.length > 0;
                    if (!hasMedicationVisits) {
                        this.pendingVisitSelection = null;
                        const defaultMeds = this.getDefaultMedications();
                        this.currentMedications = defaultMeds;
                        this.handleAddMedicationRow(defaultMeds, {
                            visitId: null,
                        });
                        this.renderSelectionState($riwayatSelect.val(), {
                            hydrate: !skipRender,
                        });
                        this.updateDisabledVisitInfo($visitSelect, {
                            forceHide: true,
                        });
                        return;
                    }

                    const hasSelectableVisits = visitsWithMedicationFlag.some(
                        (visit) => visit.hasMedication && !visit.sentMedication,
                    );
                    this.pendingVisitSelection = hasSelectableVisits
                        ? this.getLatestEligibleVisitId(visits)
                        : null;

                    const effectiveVisitId = this.pendingVisitSelection;
                    if (effectiveVisitId) {
                        const meds =
                            this.getMedicationsForVisit(effectiveVisitId);
                        this.currentMedications = meds;
                        this.handleAddMedicationRow(meds, {
                            visitId: effectiveVisitId,
                        });
                    } else {
                        const defaultMeds = this.getDefaultMedications();
                        this.currentMedications = defaultMeds;
                        this.handleAddMedicationRow(defaultMeds, {
                            visitId: null,
                        });
                    }

                    this.renderSelectionState($riwayatSelect.val(), {
                        hydrate: !skipRender,
                    });
                    this.updateDisabledVisitInfo($visitSelect);
                },
                getVisitMetadata: function () {
                    if (this.visitMetadataSource === "options") {
                        return Array.isArray(this.visitMetadataCache)
                            ? this.visitMetadataCache
                            : [];
                    }
                    let visitSource =
                        dataJSON?.riwayat_kunjungan ??
                        dataJSON?.visit_history ??
                        null;
                    const hasExplicitSource =
                        Array.isArray(visitSource) ||
                        isPlainObject(visitSource) ||
                        (typeof visitSource === "string" &&
                            hasEffectiveValue(visitSource));
                    if (hasExplicitSource) {
                        const normalized =
                            this.normalizeVisitCollection(visitSource);
                        this.visitMetadataCache = normalized;
                        this.visitMetadataSource = "dataJSON";
                        return normalized;
                    }
                    return Array.isArray(this.visitMetadataCache)
                        ? this.visitMetadataCache
                        : [];
                },
                resolveInitialVisitIdFromData: function (
                    visits = this.getVisitMetadata(),
                ) {
                    if (
                        isPlainObject(dataJSON) &&
                        hasEffectiveValue(
                            dataJSON["pilih_riwayat_kunjungan_sebelumnya"],
                        )
                    ) {
                        return String(
                            dataJSON["pilih_riwayat_kunjungan_sebelumnya"],
                        ).trim();
                    }

                    const normalizedVisits = Array.isArray(visits)
                        ? visits
                        : [];

                    const selectByRecency = (collection) => {
                        if (!Array.isArray(collection) || !collection.length) {
                            return null;
                        }
                        const sorted = collection.slice().sort((a, b) => {
                            if (a.createdAt && b.createdAt) {
                                return b.createdAt - a.createdAt;
                            }
                            if (a.createdAt && !b.createdAt) {
                                return -1;
                            }
                            if (!a.createdAt && b.createdAt) {
                                return 1;
                            }
                            const orderA =
                                typeof a.order === "number" ? a.order : 0;
                            const orderB =
                                typeof b.order === "number" ? b.order : 0;
                            return orderB - orderA;
                        });
                        const candidate = sorted[0];
                        if (candidate && hasEffectiveValue(candidate.id)) {
                            return String(candidate.id);
                        }
                        return null;
                    };

                    const prioritized = normalizedVisits.filter((visit) => {
                        if (
                            !visit ||
                            !hasEffectiveValue(visit.id) ||
                            visit.sentMedication
                        ) {
                            return false;
                        }
                        const meds = this.getMedicationsForVisit(visit.id, {
                            fallback: false,
                        });
                        return Array.isArray(meds) && meds.length > 0;
                    });
                    const prioritizedId = selectByRecency(prioritized);
                    if (prioritizedId) {
                        return prioritizedId;
                    }

                    const withMeds = normalizedVisits.filter((visit) => {
                        if (!visit || !hasEffectiveValue(visit.id)) {
                            return false;
                        }
                        const meds = this.getMedicationsForVisit(visit.id, {
                            fallback: false,
                        });
                        return Array.isArray(meds) && meds.length > 0;
                    });
                    const withMedsId = selectByRecency(withMeds);
                    if (withMedsId) {
                        return withMedsId;
                    }

                    const rawVisits = Array.isArray(dataJSON?.riwayat_kunjungan)
                        ? dataJSON.riwayat_kunjungan
                        : [];
                    for (let i = 0; i < rawVisits.length; i++) {
                        const normalized = this.normalizeVisitEntry(
                            rawVisits[i],
                            i,
                        );
                        if (
                            !normalized ||
                            !hasEffectiveValue(normalized.id) ||
                            normalized.sentMedication
                        ) {
                            continue;
                        }
                        const meds = this.getMedicationsForVisit(
                            normalized.id,
                            { fallback: false },
                        );
                        if (Array.isArray(meds) && meds.length > 0) {
                            return normalized.id;
                        }
                    }
                    for (let i = 0; i < rawVisits.length; i++) {
                        const normalized = this.normalizeVisitEntry(
                            rawVisits[i],
                            i,
                        );
                        if (!normalized || !hasEffectiveValue(normalized.id)) {
                            continue;
                        }
                        const meds = this.getMedicationsForVisit(
                            normalized.id,
                            { fallback: false },
                        );
                        if (Array.isArray(meds) && meds.length > 0) {
                            return normalized.id;
                        }
                    }

                    const fallbackLatest =
                        this.getLatestEligibleVisitId(normalizedVisits);
                    if (hasEffectiveValue(fallbackLatest)) {
                        return String(fallbackLatest);
                    }

                    const fallbackVisit = normalizedVisits.find(
                        (visit) => visit && hasEffectiveValue(visit.id),
                    );
                    if (fallbackVisit) {
                        return String(fallbackVisit.id);
                    }

                    return null;
                },
                getLatestEligibleVisitId: function (
                    visits = this.getVisitMetadata(),
                ) {
                    const eligible = visits.filter(
                        (visit) => visit.hasMedication && !visit.sentMedication,
                    );
                    if (!eligible.length) {
                        return null;
                    }
                    eligible.sort((a, b) => {
                        if (a.createdAt && b.createdAt) {
                            return b.createdAt - a.createdAt;
                        }
                        if (a.createdAt && !b.createdAt) {
                            return -1;
                        }
                        if (!a.createdAt && b.createdAt) {
                            return 1;
                        }
                        return b.order - a.order;
                    });
                    return eligible[0].id;
                },
                getFirstAvailableVisitId: function ($select) {
                    let fallbackId = null;
                    $select.find("option").each(function () {
                        const $option = $(this);
                        const value = $option.attr("value");
                        if (!value || $option.is(":disabled")) {
                            return;
                        }
                        fallbackId = value;
                        return false;
                    });
                    return fallbackId;
                },
                filterVisitOptions: function ($select) {
                    const visits = this.getVisitMetadata();
                    const metadataReady = this.isVisitMetadataReady();
                    const persistedVisitValue =
                        isPlainObject(dataJSON) &&
                        hasEffectiveValue(
                            dataJSON["pilih_riwayat_kunjungan_sebelumnya"],
                        )
                            ? String(
                                  dataJSON[
                                      "pilih_riwayat_kunjungan_sebelumnya"
                                  ],
                              )
                            : null;
                    if (!metadataReady) {
                        this.enableInternalOption({ skipRefresh: true });
                        this.updateDisabledVisitInfo($select, {
                            forceHide: true,
                        });
                        return;
                    }
                    if (!visits.length) {
                        this.handleEmptyVisitHistory($select);
                        return;
                    }
                    const visitMap = new Map();
                    visits.forEach((visit) => {
                        visitMap.set(String(visit.id), visit);
                    });
                    const seenValues = new Set();
                    $select.find("option").each(function () {
                        const $option = $(this);
                        const value = $option.attr("value");
                        if (!value) {
                            return;
                        }
                        if (seenValues.has(value)) {
                            $option.remove();
                            return;
                        }
                        seenValues.add(value);
                        const meta = visitMap.get(String(value));
                        if (!meta) {
                            return;
                        }
                        if (!meta.hasMedication && !meta.sentMedication) {
                            $option.remove();
                            return;
                        }
                        if (meta.sentMedication) {
                            const isPersistedSelection =
                                persistedVisitValue !== null &&
                                persistedVisitValue === String(meta.id);
                            if (isPersistedSelection) {
                                $option
                                    .prop("disabled", false)
                                    .attr("data-disabled", "true")
                                    .attr("data-visit-status", "sent-selected");
                            } else {
                                $option
                                    .prop("disabled", true)
                                    .attr("data-disabled", "true")
                                    .attr("data-visit-status", "sent");
                            }
                            if (meta.resourceId) {
                                $option.attr(
                                    "data-resource-id",
                                    meta.resourceId,
                                );
                                $option.attr(
                                    "title",
                                    `Resource ID: ${meta.resourceId}`,
                                );
                            } else {
                                $option.removeAttr("data-resource-id");
                                $option.removeAttr("title");
                            }
                        } else {
                            $option
                                .prop("disabled", false)
                                .removeAttr("data-disabled")
                                .attr("data-visit-status", "available");
                            if (meta.resourceId) {
                                $option.attr(
                                    "data-resource-id",
                                    meta.resourceId,
                                );
                                $option.attr(
                                    "title",
                                    `Resource ID: ${meta.resourceId}`,
                                );
                            } else {
                                $option.removeAttr("data-resource-id");
                                $option.removeAttr("title");
                            }
                        }
                    });
                    this.enableInternalOption();
                    this.updateDisabledVisitInfo($select);
                    if (
                        $select &&
                        $select.length &&
                        persistedVisitValue !== null
                    ) {
                        const currentVal = $select.val();
                        if (
                            !currentVal &&
                            $select.find(
                                `option[value="${persistedVisitValue}"]`,
                            ).length
                        ) {
                            $select.val(persistedVisitValue);
                            if ($select.hasClass("select2-hidden-accessible")) {
                                $select.trigger("change.select2");
                            } else {
                                $select.trigger("change");
                            }
                        }
                        this.clearVisitSelectValidation($select);
                        validateField($select);
                    }
                },
                hideVisitSelection: function () {
                    const $select = $("#pilih_riwayat_kunjungan_sebelumnya");
                    if (!$select.length) {
                        return;
                    }
                    const $formGroup = $select.closest(".form-group");
                    if (!$formGroup.hasClass("hidden")) {
                        $formGroup.addClass("hidden");
                    }
                    const $select2Container = $select.next(".select2");
                    if ($select2Container.length) {
                        $select2Container.hide();
                    }
                    $select.attr("readonly", "readonly");
                },
                showVisitSelection: function () {
                    const $select = $("#pilih_riwayat_kunjungan_sebelumnya");
                    if (!$select.length) {
                        return;
                    }
                    const $formGroup = $select.closest(".form-group");
                    $formGroup.removeClass("hidden");
                    const $select2Container = $select.next(".select2");
                    if ($select2Container.length) {
                        $select2Container.show();
                    }
                    $select.removeAttr("readonly");
                },
                updateDisabledVisitInfo: function ($select, options = {}) {
                    const $info = $("#disabled-visit-info");
                    if (!$info.length) {
                        return;
                    }
                    if (options?.forceHide) {
                        $info.hide().empty();
                        return;
                    }
                    if (!$select || !$select.length) {
                        $info.hide().empty();
                        return;
                    }
                    if (!$("#internal-visit-container").is(":visible")) {
                        $info.hide().empty();
                        return;
                    }
                    const visits = this.getVisitMetadata();
                    const disabledVisitMap = new Map();
                    visits.forEach((visit) => {
                        if (
                            (visit.hasMedication || visit.sentMedication) &&
                            visit.sentMedication
                        ) {
                            disabledVisitMap.set(String(visit.id), visit);
                        }
                    });
                    const disabledVisits = Array.from(
                        disabledVisitMap.values(),
                    );
                    if (!disabledVisits.length) {
                        $info.hide().empty();
                        return;
                    }
                    const listItems = disabledVisits
                        .map((visit, index) => {
                            const $option = $select
                                .find("option")
                                .filter(function () {
                                    return (
                                        String($(this).attr("value")) ===
                                        String(visit.id)
                                    );
                                })
                                .first();
                            let label =
                                ($option.length ? $option.text() : "") ||
                                visit?.raw?.label ||
                                visit?.raw?.name ||
                                visit.id;
                            label = (label || visit.id || "").toString().trim();
                            const resourceId =
                                visit.resourceId ||
                                visit?.raw?.resource_id ||
                                visit?.raw?.resourceId ||
                                "";
                            const sanitizedId = (visit.id || `visit-${index}`)
                                .toString()
                                .replace(/[^a-zA-Z0-9_-]/g, "");
                            const codeId = `disabled-resource-${index}-${sanitizedId || index}`;
                            const hasResource = Boolean(resourceId);
                            const toggleControl = hasResource
                                ? `<button type="button" class="btn-link btn-xs toggle-resource-id" data-target="#${codeId}">Lihat Resource ID</button>`
                                : `<span class="resource-not-available">Resource ID tidak tersedia</span>`;
                            const codeBlock = hasResource
                                ? `<code id="${codeId}" class="resource-id-code">${escapeHtml(resourceId)}</code>`
                                : "";
                            return `
                            <li class="disabled-visit-item">
                                <div class="visit-item-row">
                                    <span class="visit-label">${escapeHtml(label)}</span>
                                    ${toggleControl}
                                </div>
                                ${codeBlock}
                            </li>`;
                        })
                        .join("");
                    $info
                        .html(
                            `
                        <details class="disabled-visit-details">
                            <summary>Riwayat kunjungan yang sudah dikirim (${disabledVisits.length})</summary>
                            <ul class="disabled-visit-list">
                                ${listItems}
                            </ul>
                        </details>
                    `,
                        )
                        .show();
                },
                enableInternalOption: function (options = {}) {
                    const skipRefresh = options?.skipRefresh === true;
                    const $riwayatSelect = $("#pilih_riwayat");
                    const added = this.addOption(
                        $riwayatSelect,
                        RIWAYAT_OPTIONS.internal,
                    );
                    if (
                        added &&
                        !skipRefresh &&
                        $riwayatSelect.hasClass("select2-hidden-accessible")
                    ) {
                        $riwayatSelect.trigger("change.select2");
                    }
                    this.internalOptionVisible = true;
                },
                disableInternalOption: function (options = {}) {
                    if (!this.internalOptionVisible) {
                        return;
                    }
                    const skipRefresh = options?.skipRefresh === true;
                    const $riwayatSelect = $("#pilih_riwayat");
                    const removed = this.removeOption(
                        $riwayatSelect,
                        RIWAYAT_OPTIONS.internal.value,
                    );
                    if (
                        removed &&
                        !skipRefresh &&
                        $riwayatSelect.hasClass("select2-hidden-accessible")
                    ) {
                        $riwayatSelect.trigger("change.select2");
                    }
                    this.internalOptionVisible = false;
                },
                handleNoInternalAvailable: function (options = {}) {
                    this.pendingVisitSelection = null;
                    this.disableInternalOption();
                    const $riwayatSelect = $("#pilih_riwayat");
                    $riwayatSelect.val("");
                    if (isPlainObject(dataJSON)) {
                        dataJSON["pilih_riwayat"] = "";
                    }
                    const hydrate = options?.hydrate !== false;
                    this.renderSelectionState("", { hydrate });
                    this.updateDisabledVisitInfo(
                        $("#pilih_riwayat_kunjungan_sebelumnya"),
                        { forceHide: true },
                    );
                },
                postVisitOptionsInit: function () {
                    const $select = $("#pilih_riwayat_kunjungan_sebelumnya");
                    this.filterVisitOptions($select);
                    const selectableOptions = $select
                        .find("option")
                        .filter(function () {
                            const value = $(this).attr("value");
                            if (!value) {
                                return false;
                            }
                            return !$(this).is(":disabled");
                        });
                    if (!selectableOptions.length) {
                        this.handleEmptyVisitHistory($select);
                        return;
                    }

                    let currentVal = $select.val();
                    if (Array.isArray(currentVal)) {
                        currentVal = currentVal[0];
                    }
                    if (currentVal) {
                        const $currentOption = $select.find(
                            `option[value="${currentVal}"]`,
                        );
                        if (
                            !$currentOption.length ||
                            $currentOption.is(":disabled")
                        ) {
                            this.isApplyingPendingVisit = true;
                            $select.val(null).trigger("change");
                            this.isApplyingPendingVisit = false;
                            currentVal = null;
                        }
                    }

                    const pendingId =
                        this.pendingVisitSelection !== null
                            ? String(this.pendingVisitSelection)
                            : null;
                    if (pendingId) {
                        const $pendingOption = $select.find(
                            `option[value="${pendingId}"]`,
                        );
                        let targetId = null;
                        if (
                            $pendingOption.length &&
                            !$pendingOption.is(":disabled")
                        ) {
                            targetId = pendingId;
                        } else {
                            targetId = this.getFirstAvailableVisitId($select);
                        }
                        this.pendingVisitSelection = null;
                        if (targetId) {
                            if (currentVal !== targetId) {
                                $select.val(targetId).trigger("change");
                            } else {
                                $select.trigger("change");
                            }
                        }
                    }
                    this.clearVisitSelectValidation($select);
                    if (!hasEffectiveValue($select.val())) {
                        const fallbackId =
                            this.getFirstAvailableVisitId($select);
                        if (fallbackId) {
                            this.isApplyingPendingVisit = true;
                            $select.val(fallbackId).trigger("change");
                            this.isApplyingPendingVisit = false;
                        }
                    }
                },
                handlePilihRiwayatChange: function (el) {
                    this.renderSelectionState($(el).val(), { hydrate: true });
                },
                handleRiwayatKunjunganSebelumnyaChange: function (el) {
                    let value = $(el).val();
                    if (Array.isArray(value)) {
                        value = value[0];
                    }
                    if (!value) {
                        this.currentMedications = [];
                        this.handleAddMedicationRow([], { visitId: null });
                        return;
                    }
                    const medications = this.getMedicationsForVisit(value, {
                        fallback: false,
                    });
                    this.currentMedications = Array.isArray(medications)
                        ? medications
                        : [];
                    this.handleAddMedicationRow(this.currentMedications, {
                        visitId: value,
                    });
                },
                handleAddMedicationRow: function (
                    medications = null,
                    options = {},
                ) {
                    const visitId =
                        options.visitId ??
                        $("#pilih_riwayat_kunjungan_sebelumnya").val();
                    this.loadMedicationOptions(visitId).always(() => {
                        this.renderMedicationRows(
                            medications,
                            Object.assign({}, options, { visitId }),
                        );
                    });
                },
                renderMedicationRows: function (
                    medications = null,
                    options = {},
                ) {
                    const medsSource = Array.isArray(medications)
                        ? medications
                        : Array.isArray(this.currentMedications) &&
                            this.currentMedications.length
                          ? this.currentMedications
                          : this.getDefaultMedications();
                    let normalizedMeds = Array.isArray(medsSource)
                        ? medsSource
                              .map((med) =>
                                  this.normalizeMedicationItem(med ?? {}),
                              )
                              .filter((med) =>
                                  this.hasMeaningfulMedication(med),
                              )
                        : [];

                    const $container = $("#medication-container");
                    const $rows = $("#medication-rows");
                    $rows.empty();

                    const visitId =
                        options.visitId ??
                        $("#pilih_riwayat_kunjungan_sebelumnya").val();
                    const visitIdForOptions = options.visitId ?? visitId;
                    const medicationOptions =
                        this.getMedicationOptionsForVisit(visitIdForOptions);

                    const matchMedicationOption = (med) => {
                        if (!med || typeof med !== "object") {
                            return null;
                        }
                        const candidates = [
                            med.id,
                            med.nama_obat,
                            med.nama_obat_display,
                        ]
                            .filter(hasEffectiveValue)
                            .map((value) => String(value).toLowerCase());
                        if (!candidates.length) {
                            return null;
                        }
                        return (
                            medicationOptions.find((option) => {
                                if (!option || typeof option !== "object") {
                                    return false;
                                }
                                const optionCandidates = [
                                    option.id,
                                    option.nama_obat,
                                    option.nama_obat_display,
                                ]
                                    .filter(hasEffectiveValue)
                                    .map((value) =>
                                        String(value).toLowerCase(),
                                    );
                                if (!optionCandidates.length) {
                                    return false;
                                }
                                return candidates.some((candidate) =>
                                    optionCandidates.includes(candidate),
                                );
                            }) ?? null
                        );
                    };

                    if (normalizedMeds.length && medicationOptions.length) {
                        normalizedMeds = normalizedMeds
                            .map((med) => {
                                const matched = matchMedicationOption(med);
                                if (matched) {
                                    return Object.assign({}, matched, med);
                                }
                                return med;
                            })
                            .filter((med) => this.hasMeaningfulMedication(med));
                    }

                    if (!normalizedMeds.length && medicationOptions.length) {
                        normalizedMeds = medicationOptions.filter((med) =>
                            this.hasMeaningfulMedication(med),
                        );
                    }

                    const rowsToRender = normalizedMeds.length
                        ? normalizedMeds
                        : [this.createEmptyMedication()];

                    if (!rowsToRender.length) {
                        this.currentMedications = [];
                        $container.hide();
                        initialized = true;
                        return;
                    }

                    this.currentMedications = normalizedMeds.length
                        ? normalizedMeds
                        : [];
                    rowsToRender.forEach((med) => {
                        this.addMedicationRow(med, {
                            visitId,
                            medicationOptions,
                        });
                    });
                    $container.show();
                    if (
                        typeof SatusehatForm !== "undefined" &&
                        SatusehatForm.CollapsibleSections &&
                        typeof SatusehatForm.CollapsibleSections
                            .refreshForField === "function"
                    ) {
                        const $firstField = $rows
                            .find("input, select")
                            .filter(":enabled")
                            .first();
                        SatusehatForm.CollapsibleSections.refreshForField(
                            $firstField,
                        );
                    }
                    initialized = true;
                },
                addMedicationRow: function (medicationData = {}, options = {}) {
                    let template = document.getElementById(
                        "medication-row-template",
                    );
                    let clone = document.importNode(template.content, true);
                    document
                        .getElementById("medication-rows")
                        .appendChild(clone);
                    let newRow = $("#medication-rows tr.medication-row:last");
                    SatusehatForm.Select2.initializeSelect2Row(
                        newRow,
                        medicationData,
                        options,
                    );
                    newRow.find(".dosis").val(medicationData?.dosis ?? "");
                    newRow
                        .find(".frekuensi")
                        .val(medicationData?.frekuensi ?? "");
                    newRow.find(".periode").val(medicationData?.periode ?? "");
                    newRow
                        .find(".maksimal")
                        .val(medicationData?.maksimal ?? "");
                    if (hasEffectiveValue(medicationData?.unit)) {
                        newRow
                            .find(".unit")
                            .val(medicationData.unit)
                            .trigger("change.select2");
                    }
                    if (newRow.closest(".collapsible-content").is(":visible")) {
                        newRow.find("input, select").prop("disabled", false);
                        newRow
                            .find('[data-is-mandatory="true"]')
                            .prop("required", true);
                    } else {
                        newRow.find("input, select").prop("disabled", true);
                        newRow
                            .find('[data-is-mandatory="true"]')
                            .prop("required", false);
                    }
                    newRow.find('[data-is-mandatory="true"]').each(function () {
                        validateField($(this));
                    });
                    if (
                        typeof SatusehatForm !== "undefined" &&
                        SatusehatForm.CollapsibleSections &&
                        typeof SatusehatForm.CollapsibleSections
                            .refreshForField === "function"
                    ) {
                        SatusehatForm.CollapsibleSections.refreshForField(
                            newRow.find('[data-is-mandatory="true"]').first(),
                        );
                    }
                },
                getDefaultMedications: function () {
                    if (!isPlainObject(dataJSON)) {
                        return [];
                    }
                    return this.extractMedicationsFromEntry(dataJSON);
                },
                getMedicationsForVisit: function (visitId, options = {}) {
                    const normalizedId = hasEffectiveValue(visitId)
                        ? String(visitId)
                        : "";
                    let meds = [];
                    const fallbackToDefault = options?.fallback !== false;
                    if (
                        normalizedId &&
                        Array.isArray(dataJSON?.riwayat_kunjungan)
                    ) {
                        const entry = dataJSON.riwayat_kunjungan.find(
                            (visit) => {
                                const candidates = [
                                    visit?.id,
                                    visit?.visit_id,
                                    visit?.regpid,
                                    visit?.REGPID,
                                    visit?.value,
                                    visit?.kode,
                                    visit?.code,
                                ].filter(hasEffectiveValue);
                                return candidates.some(
                                    (candidate) =>
                                        String(candidate) === normalizedId,
                                );
                            },
                        );
                        if (entry) {
                            meds = this.extractMedicationsFromEntry(entry);
                            if (!Array.isArray(meds) || !meds.length) {
                                const fallbackMeds = [];
                                if (Array.isArray(entry.meds)) {
                                    entry.meds.forEach((med) => {
                                        const normalized =
                                            this.normalizeMedicationItem(
                                                med ?? {},
                                            );
                                        if (
                                            this.hasMeaningfulMedication(
                                                normalized,
                                            )
                                        ) {
                                            fallbackMeds.push(normalized);
                                        }
                                    });
                                }
                                if (Array.isArray(entry?.nama_obat)) {
                                    const names = entry.nama_obat;
                                    const dosis = entry?.dosis ?? [];
                                    const frekuensi = entry?.frekuensi ?? [];
                                    const periode = entry?.periode ?? [];
                                    const maksimal = entry?.maksimal ?? [];
                                    const unit = entry?.unit ?? [];
                                    const displays =
                                        entry?.nama_obat_display ?? [];
                                    const medTypes = entry?.med_type ?? [];
                                    names.forEach((nama, idx) => {
                                        const med = {
                                            nama_obat: nama ?? "",
                                            nama_obat_display:
                                                displays[idx] ?? "",
                                            dosis: dosis[idx] ?? "",
                                            frekuensi: frekuensi[idx] ?? "",
                                            periode: periode[idx] ?? "",
                                            maksimal: maksimal[idx] ?? "",
                                            unit: unit[idx] ?? "",
                                            med_type: medTypes[idx] ?? "",
                                        };
                                        const normalized =
                                            this.normalizeMedicationItem(med);
                                        if (
                                            this.hasMeaningfulMedication(
                                                normalized,
                                            )
                                        ) {
                                            fallbackMeds.push(normalized);
                                        }
                                    });
                                }
                                meds = this.dedupeMedications(fallbackMeds);
                            }
                        }
                    }
                    if (!meds.length) {
                        if (!fallbackToDefault) {
                            return [];
                        }
                        return this.getDefaultMedications();
                    }
                    return meds;
                },
            },

            /**
             * Signature (TTD) functionalities
             * @namespace TTD
             * @description Manages signature selection, display, and integration with the form, including handling signature creation via a popup.
             **/
            TTD: {
                SetTTD: function () {
                    $('input[data-name="paraf"]').each(function () {
                        let id = $(this).attr("data-id"),
                            ttd = $(this).val();
                        ImageToText(id, ttd);
                    });
                },
                handleTTDSelection: function (element) {
                    let name = $(element).attr("name"),
                        name_txt = $(element).find("option:selected").text(),
                        name_img = $(element)
                            .find("option:selected")
                            .attr("data-ttd"),
                        id = $(element).attr("data-id");
                    $("#" + name + "_txt").val(name_txt);
                    ImageToText(id, name_img);
                },
                ttd_paraf: function (id) {
                    PopupCenter(
                        "index.php?mod=ttd_pentablet_2&cmd=ttd_pentablet_2&jenis=" +
                            id +
                            "&pid=" +
                            window.PID +
                            "&regpid=" +
                            window.REGPID,
                        "pop",
                        800,
                        400,
                    );
                },
                tampil_ttd_2: function (x, y) {
                    ImageToText(x, y);
                },
            },
        };
    })(jQuery);

    // Initialize the form
    $(document).ready(function () {
        SatusehatForm.init();

        // Event handlers
        $("#pilih_riwayat").on("change", function () {
            SatusehatForm.Medication.handlePilihRiwayatChange(this);
        });
        $("#pilih_riwayat_kunjungan_sebelumnya").on("change", function () {
            SatusehatForm.Medication.handleRiwayatKunjunganSebelumnyaChange(
                this,
            );
        });
        $(document)
            .off("click", "#CreateTTD")
            .on("click", "#CreateTTD", function () {
                let id = $(this).attr("data-id");
                SatusehatForm.TTD.ttd_paraf(id);
            });
        $(document)
            .off("change", 'select[data-var="set_name_sel"]')
            .on("change", 'select[data-var="set_name_sel"]', function () {
                SatusehatForm.TTD.handleTTDSelection(this);
            });
        $(document).on("click", ".toggle-resource-id", function (event) {
            event.preventDefault();
            const targetSelector = $(this).attr("data-target");
            if (!targetSelector) {
                return;
            }
            const $code = $(targetSelector);
            if (!$code.length) {
                return;
            }
            const isVisible = $code.hasClass("is-visible");
            if (isVisible) {
                $code.removeClass("is-visible");
                $(this).text("Lihat Resource ID");
            } else {
                $code.addClass("is-visible");
                $(this).text("Sembunyikan Resource ID");
            }
        });
    });
</script>

<style type="text/css">
    :root {
        --primary-50: #f2f6ff;
        --primary-100: #dfe7ff;
        --primary-200: #b9ccff;
        --primary-400: #5a82e8;
        --primary-500: #3c6abd;
        --primary-600: #2f5294;
        --accent-amber: #f8b84a;
        --surface-50: #fbfcfe;
        --surface-100: #f5f7fb;
        --surface-200: #e9edf5;
        --surface-300: #dde3ef;
        --text-primary: #1f2a44;
        --text-secondary: #4f5d7a;
        --text-muted: #7987a1;
        --border-soft: #dbe3f3;
        --border-strong: #c4d1ea;
        --danger-500: #dc3545;
        --shadow-soft: 0 18px 40px -20px rgba(30, 53, 96, 0.35);
    }

    .satusehat-form {
        position: relative;
        padding: 28px 32px 38px;
        border-radius: 18px;
        background: linear-gradient(
            135deg,
            rgba(255, 255, 255, 0.98),
            rgba(247, 250, 255, 0.96)
        );
        box-shadow: var(--shadow-soft);
        color: var(--text-primary);
        font-family:
            "Inter",
            "Segoe UI",
            -apple-system,
            BlinkMacSystemFont,
            sans-serif;
        font-size: 1.05rem;
        line-height: 1.65;
    }

    .form-hero {
        background: rgba(255, 255, 255, 0.95);
        border: 1px solid rgba(215, 223, 240, 0.65);
        border-radius: 20px;
        padding: 26px 28px 24px;
        margin-bottom: 22px;
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.5);
        display: grid;
        gap: 22px;
    }

    .form-hero__intro {
        max-width: 760px;
    }

    .form-hero__intro p {
        max-width: 680px;
    }

    .form-hero__pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        background: var(--primary-50);
        border: 1px solid var(--primary-200);
        color: var(--primary-600);
        padding: 6px 14px;
        border-radius: 999px;
        font-weight: 600;
        font-size: 0.85rem;
        letter-spacing: 0.12em;
        text-transform: uppercase;
        margin-bottom: 12px;
    }

    .form-hero h1 {
        margin-bottom: 12px;
    }

    .form-hero__meta {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 16px;
    }

    .form-hero__item {
        background: rgba(255, 255, 255, 0.88);
        border: 1px solid rgba(215, 223, 240, 0.7);
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.6);
    }

    .satusehat-form h1 {
        font-size: 2.15rem;
        font-weight: 700;
        color: var(--primary-600);
        margin: 0;
        letter-spacing: -0.02em;
    }

    .satusehat-form p {
        color: var(--text-secondary);
        line-height: 1.6;
        margin-top: 8px;
        margin-bottom: 0;
    }

    .satusehat-form input,
    .satusehat-form textarea,
    .satusehat-form select {
        border: 1px solid var(--border-soft);
        border-radius: 10px;
        padding: 9px 12px;
        width: 100%;
        box-sizing: border-box;
        background: #fff;
        color: var(--text-primary);
        transition:
            border-color 0.2s ease,
            box-shadow 0.2s ease;
        font-size: 0.95rem;
    }

    .satusehat-form input:focus,
    .satusehat-form textarea:focus,
    .satusehat-form select:focus {
        outline: none;
        border-color: var(--primary-400);
        box-shadow: 0 0 0 3px rgba(90, 130, 232, 0.18);
    }

    .satusehat-form input:read-only,
    .satusehat-form textarea:read-only {
        border: 1px dashed var(--border-soft);
        background-color: rgba(240, 243, 253, 0.6) !important;
        color: var(--text-secondary);
        font-style: normal;
        pointer-events: none;
    }

    .satusehat-form label[for] {
        font-size: 0.95rem;
        font-weight: 600;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.08em;
        margin-bottom: 6px;
        display: inline-block;
    }

    .satusehat-form .section-header {
        background: linear-gradient(
            100deg,
            rgba(60, 106, 189, 0.12),
            rgba(60, 106, 189, 0)
        );
        padding: 16px 18px;
        margin-top: 26px;
        margin-bottom: 0;
        border: 1px solid rgba(60, 106, 189, 0.18);
        border-radius: 14px;
        font-weight: 600;
        cursor: pointer;
        position: relative;
        transition: all 0.25s ease;
        display: flex;
        justify-content: space-between;
        align-items: center;
        color: var(--primary-600);
    }

    .satusehat-form .section-header:hover {
        background: linear-gradient(
            95deg,
            rgba(60, 106, 189, 0.18),
            rgba(60, 106, 189, 0.05)
        );
        box-shadow: 0 12px 30px -16px rgba(60, 106, 189, 0.45);
        transform: translateY(-1px);
    }

    .satusehat-form .section-header::after {
        content: "Klik untuk membuka";
        position: absolute;
        right: 50px;
        color: var(--text-muted);
        font-size: 0.68rem;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.16em;
        opacity: 0;
        transition: opacity 0.2s ease;
    }

    .satusehat-form .section-header:hover::after {
        opacity: 1;
    }

    .satusehat-form .section-header.active {
        background: linear-gradient(
            100deg,
            rgba(60, 106, 189, 0.85),
            rgba(60, 106, 189, 0.65)
        );
        color: #fff;
        border-color: rgba(60, 106, 189, 0.6);
    }

    .satusehat-form .section-header.active::after {
        content: "Sembunyikan";
        color: rgba(255, 255, 255, 0.85);
        opacity: 1;
    }

    .satusehat-form .section-header::before {
        content: "\f078";
        font-family: FontAwesome;
        position: absolute;
        right: 20px;
        transition: transform 0.3s ease;
    }

    .satusehat-form .section-header.active::before {
        transform: rotate(180deg);
        color: rgba(255, 255, 255, 0.85);
    }

    .satusehat-form .collapsible-content {
        padding: 22px 24px 26px;
        border: 1px solid rgba(215, 223, 240, 0.9);
        border-top: none;
        margin-bottom: 14px;
        border-bottom-left-radius: 16px;
        border-bottom-right-radius: 16px;
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.4);
        background: rgba(250, 252, 255, 0.9);
        backdrop-filter: blur(6px);
        transition: border-color 0.25s ease;
    }

    .satusehat-form .section-header .section-number {
        background: rgba(60, 106, 189, 0.12);
        color: var(--primary-600);
        padding: 6px 11px;
        border-radius: 8px;
        margin-right: 12px;
        font-weight: 700;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 36px;
        font-size: 0.85rem;
    }

    .satusehat-form .section-header.active .section-number {
        background: rgba(255, 255, 255, 0.22);
        color: #fff;
    }

    .satusehat-form .section-header small {
        opacity: 0.65;
        margin-left: 0.65rem;
        font-weight: 500;
        letter-spacing: 0.08em;
    }

    .satusehat-form .form-row,
    .satusehat-form .section-two-columns {
        display: grid;
        grid-template-columns: 35% 1fr;
        /* grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); */
        gap: 22px;
    }

    .keluhan-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 22px;
        margin-bottom: 10px;
    }

    .keluhan-column {
        display: flex;
        flex-direction: column;
        gap: 18px;
    }

    .visit-selection {
        display: flex;
        flex-direction: column;
        gap: 18px;
        margin-top: 24px;
    }

    .satusehat-form .left-column,
    .satusehat-form .right-column {
        display: flex;
        flex-direction: column;
        gap: 18px;
    }

    .satusehat-form .right-column {
        /* display: grid; */
        gap: 18px;
    }

    .careplan-single-column {
        width: 100%;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 18px;
    }

    .followup-grid {
        width: 100%;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 18px;
    }

    .followup-card {
        background: rgba(255, 255, 255, 0.92);
        border: 1px solid rgba(215, 223, 240, 0.7);
        border-radius: 16px;
        padding: 18px 20px 20px;
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.55);
        display: flex;
        flex-direction: column;
        gap: 18px;
    }

    .followup-card__header {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    .followup-card__badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-weight: 700;
        color: var(--primary-600);
        letter-spacing: 0.04em;
        text-transform: uppercase;
        font-size: 0.95rem;
    }

    .followup-card__hint {
        font-size: 0.9rem;
        color: var(--text-muted);
        line-height: 1.45;
    }

    .followup-card__body {
        display: grid;
        gap: 16px;
    }

    .satusehat-form .form-group {
        display: flex;
        flex-direction: column;
        gap: 10px;
        background: rgba(255, 255, 255, 0.85);
        border: 1px solid rgba(215, 223, 240, 0.6);
        border-radius: 14px;
        padding: 14px 16px;
        margin: 0;
        transition:
            box-shadow 0.2s ease,
            transform 0.2s ease;
    }

    .satusehat-form .form-group:hover {
        box-shadow: 0 18px 26px -22px rgba(60, 106, 189, 0.6);
        transform: translateY(-1px);
    }

    .satusehat-form .form-group:last-child {
        margin-right: 0;
    }

    .form-hero .form-group {
        background: rgba(255, 255, 255, 0.88);
        border: 1px solid rgba(215, 223, 240, 0.7);
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.6);
    }

    .form-hero .form-group:hover {
        box-shadow: 0 12px 20px -18px rgba(60, 106, 189, 0.55);
    }

    .satusehat-form textarea {
        min-height: 110px;
        resize: vertical;
        line-height: 1.5;
    }

    .satusehat-form .btn {
        background: linear-gradient(
            95deg,
            var(--primary-500),
            var(--primary-600)
        );
        color: #fff;
        padding: 7px 16px;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 600;
        box-shadow: 0 12px 18px -14px rgba(60, 106, 189, 0.75);
        transition:
            transform 0.2s ease,
            box-shadow 0.2s ease;
    }

    .satusehat-form .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 14px 24px -18px rgba(60, 106, 189, 0.8);
    }

    .satusehat-form .btn:active {
        transform: translateY(0);
    }

    .satusehat-form .smart-form {
        font-size: 12px;
        background: rgba(255, 255, 255, 0.92);
        border: 1px solid rgba(215, 223, 240, 0.5);
        border-radius: 12px;
        padding: 14px;
    }

    .satusehat-form .smart-form .row {
        width: 100%;
        margin: 0;
    }

    .satusehat-form .image-paraf {
        width: 180px;
        height: 100px;
        object-fit: contain;
        border: 1px solid rgba(215, 223, 240, 0.9);
        border-radius: 10px;
        background: #fff;
        padding: 6px;
    }

    .satusehat-form .datepicker {
        width: 100%;
        background-image: linear-gradient(
            to right,
            rgba(90, 130, 232, 0.18),
            rgba(90, 130, 232, 0)
        );
    }

    .satusehat-form .hidden {
        display: none;
    }

    /* Select2 */
    .select2-container--default {
        width: 100% !important;
    }

    .select2-container .select2-selection--single {
        min-height: 40px;
        border-radius: 10px;
        border: 1px solid var(--border-soft);
        padding: 8px 40px 8px 12px;
        display: block;
        position: relative;
        transition:
            border-color 0.2s ease,
            box-shadow 0.2s ease;
    }

    .select2-container--default
        .select2-selection--single
        .select2-selection__rendered {
        color: var(--text-primary);
        line-height: 1.5;
        padding: 0;
        margin: 0;
    }

    .select2-container--default
        .select2-selection--single
        .select2-selection__arrow {
        height: 100%;
        right: 12px;
        top: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        border: none;
        background: none;
    }

    .select2-container .select2-search--inline .select2-search__field {
        margin: 0 !important;
    }

    .select2-container--default
        .select2-selection--single
        .select2-selection__arrow
        b {
        margin: 0;
    }

    .select2-container--default
        .select2-selection--single
        .select2-selection__arrow
        b::before {
        content: "";
    }

    .select2-container--default
        .select2-selection--multiple
        .select2-selection__choice {
        background-color: var(--primary-50);
        border: 1px solid var(--primary-200);
        border-radius: 8px;
        padding: 4px 10% 4px 12px;
        margin: 0;
        color: var(--primary-600);
        font-weight: 500;
    }

    .select2-container--default
        .select2-selection--multiple
        .select2-selection__choice__remove {
        /* margin-right: 6px; */
        height: 100%;
        display: flex;
        align-items: anchor-center;
        color: var(--primary-600);
    }

    .select2-container--default
        .select2-selection--multiple
        .select2-selection__choice__remove:hover {
        color: var(--primary-400);
    }

    .select2-container--default .select2-selection--single:hover,
    .select2-container--default .select2-selection--multiple:hover {
        border-color: var(--primary-200);
    }

    .select2-container .select2-selection--multiple {
        min-height: 40px;
        border-radius: 10px;
        border: 1px solid var(--border-soft);
        padding: 6px 8px;
        background-color: #fff;
        transition:
            border-color 0.2s ease,
            box-shadow 0.2s ease;
    }

    .select2-container--default
        .select2-selection--multiple
        .select2-selection__rendered {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 6px;
        padding: 0;
    }

    .select2-container--default.select2-container--focus
        .select2-selection--multiple,
    .select2-container--default.select2-container--focus
        .select2-selection--single {
        border-color: var(--primary-400);
        box-shadow: 0 0 0 3px rgba(90, 130, 232, 0.18);
    }

    select[readonly] + .select2-container .select2-selection {
        background: rgba(245, 247, 255, 0.65);
        border: 1px dashed var(--border-soft);
        box-shadow: none;
        padding: 6px 12px;
        pointer-events: none;
    }

    select[readonly] + .select2-container .select2-selection__arrow {
        display: none;
    }

    select[readonly] + .select2-container .select2-selection__clear {
        display: none !important;
    }

    .select2-dropdown {
        border-radius: 12px !important;
        border: 1px solid rgba(215, 223, 240, 0.85) !important;
        box-shadow: 0 22px 48px -26px rgba(30, 53, 96, 0.35);
        overflow: hidden;
    }

    .select2-results__option {
        padding: 9px 12px !important;
        white-space: normal !important;
        word-break: break-word !important;
    }

    .select2-container--default
        .select2-search--dropdown
        .select2-search__field {
        border: 1px solid rgba(215, 223, 240, 0.9) !important;
        border-radius: 8px;
        padding: 8px 10px;
    }

    .select2-results__option--highlighted[aria-selected] {
        background: rgba(90, 130, 232, 0.14) !important;
        color: var(--primary-600) !important;
    }

    .is-invalid,
    .select2-container--default .select2-selection--single.is-invalid,
    .select2-container--default .select2-selection--multiple.is-invalid {
        border-color: var(--danger-500) !important;
        background-color: rgba(255, 235, 238, 0.58) !important;
    }

    .invalid-feedback {
        display: block;
        width: 100%;
        margin-bottom: 0.45rem;
        font-size: 0.75rem;
        color: var(--danger-500);
        font-weight: 500;
    }

    #medication-container {
        width: 100%;
        margin-top: 22px;
        border: 1px solid rgba(215, 223, 240, 0.8);
        border-radius: 16px;
        padding: 18px 20px 20px;
        background-color: rgba(255, 255, 255, 0.9);
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.4);
        overflow-x: auto;
    }

    .medication-header {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        margin-bottom: 16px;
    }
    .medication-header-text {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .medication-title {
        font-weight: 700;
        font-size: 1.1rem;
        color: var(--primary-600);
        letter-spacing: -0.01em;
    }

    .medication-subtitle {
        font-size: 0.9rem;
        color: var(--text-muted);
        margin-top: 4px;
        max-width: 560px;
        line-height: 1.5;
    }

    .medication-table {
        width: 100%;
        min-width: 880px;
        border-collapse: collapse;
        border-radius: 14px;
        overflow: hidden;
        background: #fff;
        border: 1px solid rgba(215, 223, 240, 0.7);
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.6);
    }

    .medication-table thead th {
        background: linear-gradient(
            90deg,
            rgba(60, 106, 189, 0.14),
            rgba(60, 106, 189, 0.04)
        );
        padding: 14px 16px;
        font-weight: 600;
        color: var(--primary-600);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        border-bottom: 1px solid rgba(215, 223, 240, 0.9);
    }

    .medication-table td {
        padding: 14px 16px;
        border-bottom: 1px solid rgba(215, 223, 240, 0.7);
        vertical-align: middle;
        background: rgba(255, 255, 255, 0.95);
    }

    .medication-table tr:nth-child(even) td {
        background: rgba(243, 247, 255, 0.6);
    }

    .medication-table tr:last-child td {
        border-bottom: none;
    }

    .medication-col-name {
        width: 28%;
    }

    .medication-col-unit {
        width: 18%;
    }

    .nama_obat_container {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    .nama_obat-display {
        font-weight: 600;
        color: var(--text-primary);
        word-break: break-word;
        line-height: 1.45;
    }

    .medication-table input,
    .medication-table select {
        width: 100%;
    }

    .medication-table .select2-container--default .select2-selection--single {
        min-height: 40px;
    }

    @media (max-width: 900px) {
        #medication-container {
            padding: 16px;
        }

        .medication-table {
            min-width: 100%;
        }

        .medication-table thead th,
        .medication-table td {
            padding: 12px;
        }
    }

    @media (max-width: 600px) {
        .medication-table {
            font-size: 0.95rem;
        }

        .medication-table thead {
            display: none;
        }

        .medication-table,
        .medication-table tbody,
        .medication-table tr,
        .medication-table td {
            display: block;
            width: 100%;
        }

        .medication-table tr {
            border: 1px solid rgba(215, 223, 240, 0.8);
            border-radius: 14px;
            margin-bottom: 12px;
            overflow: hidden;
        }

        .medication-table td {
            border-bottom: 1px solid rgba(215, 223, 240, 0.7);
        }

        .medication-table td:last-child {
            border-bottom: none;
        }

        .medication-col-name {
            background: rgba(243, 247, 255, 0.55);
        }
    }

    .signature-section {
        display: flex;
        justify-content: flex-end;
        gap: 26px;
        margin-top: 28px;
        align-items: flex-start;
        flex-wrap: wrap;
    }

    .signature-box {
        text-align: center;
        width: 220px;
        background: rgba(255, 255, 255, 0.92);
        border: 1px solid rgba(215, 223, 240, 0.8);
        border-radius: 16px;
        padding: 20px 16px 18px;
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.35);
    }

    .signature-box b {
        display: block;
        margin-bottom: 12px;
        font-size: 1rem;
        color: var(--primary-600);
        letter-spacing: 0.04em;
    }

    .keluhan-helper {
        font-size: 0.85rem !important;
        color: var(--text-muted) !important;
        font-weight: 500;
        letter-spacing: 0.06em;
        text-transform: uppercase;
    }

    .helper-hint {
        font-size: 0.9rem;
        color: var(--text-muted);
        line-height: 1.45;
        margin-bottom: 6px;
    }

    .input-with-icon {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .input-with-icon i {
        color: var(--primary-400);
    }

    .disabled-visit-info {
        margin-top: 10px;
        font-size: 0.8rem;
        color: var(--text-muted);
    }

    .disabled-visit-details {
        border: 1px dashed rgba(215, 223, 240, 0.9);
        border-radius: 10px;
        padding: 10px 14px;
        background: rgba(242, 246, 255, 0.6);
    }

    .disabled-visit-details summary {
        cursor: pointer;
        font-weight: 600;
        color: var(--primary-600);
        outline: none;
    }

    .disabled-visit-list {
        margin: 10px 0 0;
        padding-left: 18px;
    }

    .disabled-visit-item {
        margin-bottom: 8px;
        line-height: 1.5;
    }

    .disabled-visit-item:last-child {
        margin-bottom: 0;
    }

    .disabled-visit-item .visit-item-row {
        display: flex;
        justify-content: space-between;
        gap: 12px;
        align-items: baseline;
        flex-wrap: wrap;
    }

    .disabled-visit-item .visit-label {
        font-weight: 600;
        color: var(--text-primary);
    }

    .disabled-visit-item .resource-not-available {
        font-style: italic;
        color: var(--text-muted);
        font-weight: 400;
        font-size: 0.75rem;
    }

    .disabled-visit-item .resource-id-code {
        display: none;
        margin-top: 6px;
        padding: 6px 8px;
        border-radius: 6px;
        background: rgba(60, 106, 189, 0.12);
        font-size: 0.75rem;
        color: var(--primary-600);
        word-break: break-all;
    }

    .disabled-visit-item .resource-id-code.is-visible {
        display: block;
    }

    .btn-link {
        background: none;
        border: none;
        padding: 0;
        color: var(--primary-600);
        cursor: pointer;
        text-decoration: none;
        font: inherit;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }

    .btn-link::after {
        content: "\f054";
        font-family: FontAwesome;
        font-size: 0.65rem;
        opacity: 0.6;
    }

    .btn-link:hover,
    .btn-link:focus {
        color: var(--primary-400);
        outline: none;
    }

    .btn-xs {
        font-size: 0.74rem;
        line-height: 1.25;
        font-weight: 600;
    }

    .d-flex {
        display: flex;
    }

    .justify-content-between {
        justify-content: space-between;
    }

    .justify-content-around {
        justify-content: space-around;
    }

    .w-100 {
        width: 100%;
    }

    .gap-3 {
        gap: 3%;
    }

    .gap-2 {
        gap: 2%;
    }

    .visit-option--sent {
        display: flex;
        align-items: center;
        gap: 6px;
        color: var(--danger-500);
    }

    .visit-option-icon {
        color: var(--danger-500);
    }

    .visit-option-tag {
        margin-left: auto;
        padding: 2px 8px;
        border-radius: 12px;
        background: rgba(220, 53, 69, 0.12);
        color: var(--danger-500);
        font-size: 0.65rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.08em;
    }

    .select2-results__option[aria-disabled="true"] .visit-option--sent {
        opacity: 0.85;
    }

    #alert-ihs-pasien,
    #alert-ihs-dokter {
        background: rgba(58, 190, 132, 0.15);
        border: 1px solid rgba(58, 190, 132, 0.3);
        border-radius: 12px;
        padding: 12px 14px;
        color: #268058;
        font-weight: 600;
    }

    #alert-ihs-pasien.alert-danger,
    #alert-ihs-dokter.alert-danger {
        background: rgba(220, 53, 69, 0.12);
        border-color: rgba(220, 53, 69, 0.3);
        color: var(--danger-500);
    }

    @media (max-width: 1024px) {
        .satusehat-form {
            padding: 24px;
        }

        .form-hero {
            padding: 22px;
        }

        .form-hero__meta {
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }

        .followup-grid {
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        }

        .satusehat-form .section-two-columns,
        .satusehat-form .form-row {
            grid-template-columns: repeat(1, minmax(0, 1fr));
        }

        .satusehat-form .left-column,
        .satusehat-form .right-column {
            grid-column: span 12;
        }

        .signature-section {
            justify-content: space-between;
        }
    }

    @media (max-width: 768px) {
        .satusehat-form {
            padding: 20px;
        }

        .form-hero {
            padding: 20px 18px 22px;
        }

        .form-hero__meta {
            grid-template-columns: 1fr;
        }

        .followup-grid {
            grid-template-columns: 1fr;
        }

        .satusehat-form .section-header {
            padding-right: 48px;
        }

        .satusehat-form .section-header::after {
            display: none;
        }

        .signature-section {
            flex-direction: column;
            align-items: stretch;
        }

        .signature-box {
            width: 100%;
        }
    }
</style>

<div class="satusehat-form" style="margin: 20px auto; width: 95%">
    <div
        id="alert-ihs-pasien"
        class="d-flex gap-2 alert alert-danger"
        style="align-items: center"
    >
        <i class="fa fa-exclamation-triangle"></i>
        <div>
            IHS pasien <b id="label-ihs-pasien">{PATIENT_NAME_SATUSEHAT}</b>
            <span id="status-ihs-pasien">tidak</span> tersedia
        </div>
    </div>

    <div
        id="alert-ihs-dokter"
        class="d-flex gap-2 alert alert-danger"
        style="align-items: center"
    >
        <i class="fa fa-exclamation-triangle"></i>
        <div>
            IHS dokter DPJP <b id="label-ihs-dokter">{DPJP}</b>
            <span id="status-ihs-dokter">tidak</span> tersedia
        </div>
    </div>

    <div class="form-hero">
        <div class="form-hero__intro">
            <span class="form-hero__pill">Dokumen SATUSEHAT</span>
            <h1>Formulir Dokumen SATUSEHAT</h1>
            <p>
                Silakan lengkapi formulir ini untuk pengiriman data ke
                SATUSEHAT. Pilih dan isi bagian yang relevan sesuai kebutuhan
                Anda. Setiap bagian dapat dibuka dengan mengklik judulnya.
            </p>
        </div>
        <div class="form-hero__meta">
            <div class="form-group form-hero__item">
                <label for="nama_pasien">Nama Pasien (SATUSEHAT)</label>
                <input
                    readonly=""
                    myid="check_cara"
                    type="text"
                    name="nama_pasien"
                    id="nama_pasien"
                    value=""
                    placeholder="-"
                />
            </div>
            <div class="form-group form-hero__item">
                <label for="nik">NIK</label>
                <input
                    readonly=""
                    myid="check_cara"
                    type="text"
                    name="nik"
                    id="nik"
                    value=""
                    placeholder="-"
                />
            </div>
            <div class="form-group form-hero__item">
                <label for="nomor_registrasi">Nomor Registrasi</label>
                <input
                    readonly=""
                    myid="check_cara"
                    type="text"
                    name="nomor_registrasi"
                    id="nomor_registrasi"
                    value=""
                    placeholder="-"
                />
            </div>
            <div class="form-group form-hero__item">
                <label for="ihs_pasien">IHS Pasien</label>
                <input
                    readonly=""
                    myid="check_cara"
                    type="text"
                    name="ihs_pasien"
                    id="ihs_pasien"
                    value=""
                    placeholder="-"
                />
            </div>
            <div class="form-group form-hero__item">
                <label for="departemen_layanan">Departemen Layanan</label>
                <input
                    readonly=""
                    myid="check_cara"
                    type="text"
                    name="departemen_layanan"
                    id="departemen_layanan"
                    value=""
                    placeholder="-"
                />
            </div>
            <div class="form-group form-hero__item">
                <label for="ihs_dokter">IHS Dokter</label>
                <input
                    readonly=""
                    myid="check_cara"
                    type="text"
                    name="ihs_dokter"
                    id="ihs_dokter"
                    value=""
                    placeholder="-"
                />
            </div>
            <div class="form-group hidden form-hero__item">
                <label for="tanggal_registrasi">Tanggal Registrasi</label>
                <label class="input-with-icon">
                    <i class="icon-append fa fa-calendar"></i>
                    <input
                        readonly=""
                        myid="check_cara"
                        type="text"
                        name="tanggal_registrasi"
                        id="tanggal_registrasi"
                        data-dateformat="dd/mm/yy"
                        value=""
                        placeholder="-"
                    />
                </label>
            </div>
            <div class="form-group hidden form-hero__item">
                <label for="dokter_penanggung_jawab"
                    >Dokter Penanggung Jawab</label
                >
                <input
                    readonly=""
                    myid="check_cara"
                    type="text"
                    name="dokter_penanggung_jawab"
                    id="dokter_penanggung_jawab"
                    value=""
                    placeholder="-"
                />
            </div>
            <div class="form-group form-hero__item">
                <label for="icd_10"
                    >ICD-10 (Primer) <span class="text-danger">*</span></label
                >
                <label class="select">
                    <select
                        myid="check_cara"
                        type="select"
                        name="icd10[]"
                        id="icd10"
                        data-display="ICD-10 Primer"
                        class="select2 select2-display select2-hidden-accessible"
                        multiple=""
                        data-select2-id="icd10"
                        tabindex="-1"
                        aria-hidden="true"
                        readonly="readonly"
                        data-is-mandatory="true"
                    ></select>
                    <span
                        class="select2 select2-container select2-container--default"
                        dir="ltr"
                        style="width: 100%"
                    >
                        <span class="selection">
                        <span
                                class="select2-selection select2-selection--multiple"
                                role="combobox"
                                aria-haspopup="true"
                                aria-expanded="false"
                                tabindex="-1"
                                ><ul class="select2-selection__rendered">
                                    <li
                                        class="select2-search select2-search--inline"
                                    >
                                        <input
                                            class="select2-search__field"
                                            type="search"
                                            tabindex="-1"
                                            autocomplete="off"
                                            autocorrect="off"
                                            autocapitalize="none"
                                            spellcheck="false"
                                            role="textbox"
                                            aria-autocomplete="list"
                                            placeholder="ICD-10 Primer tidak tersedia"
                                            style="width: 166.333px"
                                        />
                                    </li></ul></span></span
                        ><span
                            class="dropdown-wrapper"
                            aria-hidden="true"
                        ></span
                    ></span>
                </label>
            </div>
            <div class="form-group form-hero__item">
                <label for="icd_10_secondary">ICD-10 (Sekunder)</label>
                <label class="select">
                    <select
                        myid="check_cara"
                        type="select"
                        name="icd10_secondary[]"
                        id="icd10_secondary"
                        data-display="ICD-10 Sekunder"
                        class="select2 select2-display select2-hidden-accessible"
                        multiple=""
                        data-select2-id="icd10_secondary"
                        tabindex="-1"
                        aria-hidden="true"
                        readonly="readonly"
                    ></select
                    ><span
                        class="select2 select2-container select2-container--default"
                        dir="ltr"
                        style="width: 100%"
                        ><span class="selection"
                            ><span
                                class="select2-selection select2-selection--multiple"
                                role="combobox"
                                aria-haspopup="true"
                                aria-expanded="false"
                                tabindex="-1"
                                ><ul class="select2-selection__rendered">
                                    <li
                                        class="select2-search select2-search--inline"
                                    >
                                        <input
                                            class="select2-search__field"
                                            type="search"
                                            tabindex="-1"
                                            autocomplete="off"
                                            autocorrect="off"
                                            autocapitalize="none"
                                            spellcheck="false"
                                            role="textbox"
                                            aria-autocomplete="list"
                                            placeholder="ICD-10 Sekunder tidak tersedia"
                                            style="width: 166.333px"
                                        />
                                    </li></ul></span></span
                        ><span
                            class="dropdown-wrapper"
                            aria-hidden="true"
                        ></span
                    ></span>
                </label>
            </div>
            <div class="form-group form-hero__item">
                <label for="temporary_diagnosis">Diagnosis (Sementara)</label>
                <input
                    readonly=""
                    myid="check_cara"
                    type="textarea"
                    name="temporary_diagnosis"
                    id="temporary_diagnosis"
                    value=""
                    placeholder="-"
                />
            </div>
        </div>
    </div>

    <div
        class="section-header collapsible-trigger"
        data-target="#section1-content"
    >
        <div>
            <span class="section-number">1</span>
            RIWAYAT PENGOBATAN
            <small>MedicationStatement</small>
        </div>
    </div>
    <div id="section1-content" class="collapsible-content">
        <div class="keluhan-grid">
            <div class="keluhan-column">
                <div class="form-group">
                    <label for="keluhan_kunjungan_sebelumnya"
                        >Keluhan Kunjungan Sebelumnya</label
                    >
                    <div class="small keluhan-helper">
                        Pilih keluhan dari dropdown
                    </div>
                    <label class="select">
                        <select
                            myid="check_cara"
                            type="select"
                            name="keluhan_kunjungan_sebelumnya[]"
                            id="keluhan_kunjungan_sebelumnya"
                            class="select2 select2-hidden-accessible"
                            multiple=""
                            tabindex="-1"
                            aria-hidden="true"
                        ></select
                        ><span
                            class="select2 select2-container select2-container--default"
                            dir="ltr"
                            style="width: 100%"
                            ><span class="selection"
                                ><span
                                    class="select2-selection select2-selection--multiple"
                                    role="combobox"
                                    aria-haspopup="true"
                                    aria-expanded="false"
                                    tabindex="-1"
                                    ><ul class="select2-selection__rendered">
                                        <li
                                            class="select2-search select2-search--inline"
                                        >
                                            <input
                                                class="select2-search__field"
                                                type="search"
                                                tabindex="-1"
                                                autocomplete="off"
                                                autocorrect="off"
                                                autocapitalize="none"
                                                spellcheck="false"
                                                role="textbox"
                                                aria-autocomplete="list"
                                                placeholder="Select keluhan kunjungan sebelumnya"
                                                style="width: 538.333px"
                                            />
                                        </li></ul></span></span
                            ><span
                                class="dropdown-wrapper"
                                aria-hidden="true"
                            ></span
                        ></span>
                    </label>
                    <div style="margin-top: 8px">
                        <label
                            for="keluhan_kunjungan_sebelumnya_text"
                            class="small keluhan-helper"
                            >Catatan tambahan</label
                        >
                        <textarea
                            myid="check_cara"
                            type="textarea"
                            name="keluhan_kunjungan_sebelumnya_text"
                            id="keluhan_kunjungan_sebelumnya_text"
                            rows="3"
                            class="custom-scroll"
                        ></textarea>
                    </div>
                </div>
            </div>
            <div class="keluhan-column">
                <div class="form-group">
                    <label for="keluhan_kunjungan_sekarang"
                        >Keluhan Kunjungan Sekarang
                        <span class="text-danger">*</span></label
                    >
                    <div style="margin-top: 8px">
                        <label
                            for="keluhan_kunjungan_sekarang_soap"
                            class="small keluhan-helper"
                            >Keluhan Utama (SOAP)</label
                        >
                        <div class="helper-hint">
                            Data diambil otomatis dari SOAP kunjungan pasien
                            saat ini. Periksa ulang sebelum dikirim.
                        </div>
                        <textarea
                            readonly=""
                            type="textarea"
                            name="keluhan_kunjungan_sekarang_soap"
                            id="keluhan_kunjungan_sekarang_soap"
                            class="custom-scroll"
                        >
                        </textarea>
                    </div>
                    <div class="small keluhan-helper">
                        Pilih keluhan dari dropdown
                    </div>
                    <label class="select">
                        <select
                            myid="check_cara"
                            type="select"
                            name="keluhan_kunjungan_sekarang[]"
                            id="keluhan_kunjungan_sekarang"
                            class="select2 select2-hidden-accessible is-invalid"
                            multiple=""
                            tabindex="-1"
                            aria-hidden="true"
                            data-is-mandatory="true"
                            aria-invalid="true"
                        ></select>
                        <div class="invalid-feedback">
                            Field ini wajib diisi
                        </div>
                        <span
                            class="select2 select2-container select2-container--default is-invalid"
                            dir="ltr"
                            style="width: 100%"
                            aria-invalid="true"
                            ><span class="selection"
                                ><span
                                    class="select2-selection select2-selection--multiple is-invalid"
                                    role="combobox"
                                    aria-haspopup="true"
                                    aria-expanded="false"
                                    tabindex="-1"
                                    aria-invalid="true"
                                    ><ul class="select2-selection__rendered">
                                        <li
                                            class="select2-search select2-search--inline"
                                        >
                                            <input
                                                class="select2-search__field"
                                                type="search"
                                                tabindex="-1"
                                                autocomplete="off"
                                                autocorrect="off"
                                                autocapitalize="none"
                                                spellcheck="false"
                                                role="textbox"
                                                aria-autocomplete="list"
                                                placeholder="Select keluhan kunjungan sekarang"
                                                style="width: 538.333px"
                                            />
                                        </li></ul></span></span
                            ><span
                                class="dropdown-wrapper"
                                aria-hidden="true"
                            ></span
                        ></span>
                    </label>
                    <div style="margin-top: 8px">
                        <label
                            for="keluhan_kunjungan_sekarang_text"
                            class="small keluhan-helper"
                            >Catatan tambahan</label
                        >
                        <textarea
                            myid="check_cara"
                            type="textarea"
                            name="keluhan_kunjungan_sekarang_text"
                            id="keluhan_kunjungan_sekarang_text"
                            rows="3"
                            class="custom-scroll"
                        ></textarea>
                    </div>
                </div>
            </div>
        </div>

        <div class="visit-selection">
            <div
                class="form-group hidden"
                style="margin-bottom: 20px; flex: unset !important"
            >
                <label for="pilih_riwayat"
                    >Pilih Riwayat <span class="text-danger">*</span></label
                >
                <label class="select">
                    <select
                        myid="check_cara"
                        type="select"
                        name="pilih_riwayat"
                        id="pilih_riwayat"
                        class="select2 select2-hidden-accessible"
                        tabindex="-1"
                        aria-hidden="true"
                        data-is-mandatory="true"
                    >
                        <option value=""></option>
                        <option value="resep_internal">
                            Resep Internal
                        </option></select
                    ><span
                        class="select2 select2-container select2-container--default"
                        dir="ltr"
                        style="width: 100%"
                        ><span class="selection"
                            ><span
                                class="select2-selection select2-selection--single"
                                role="combobox"
                                aria-haspopup="true"
                                aria-expanded="false"
                                tabindex="-1"
                                aria-labelledby="select2-pilih_riwayat-container"
                                ><span
                                    class="select2-selection__rendered"
                                    id="select2-pilih_riwayat-container"
                                    title="Resep Internal"
                                    ><span class="select2-selection__clear"
                                        >Ã—</span
                                    >Resep Internal</span
                                ><span
                                    class="select2-selection__arrow"
                                    role="presentation"
                                    ><b
                                        role="presentation"
                                    ></b></span></span></span
                        ><span
                            class="dropdown-wrapper"
                            aria-hidden="true"
                        ></span
                        ><input
                            type="hidden"
                            myid="check_cara"
                            name="pilih_riwayat_display"
                            value="Resep Internal"
                    /></span>
                </label>
            </div>

            <div
                id="internal-visit-container"
                class="conditional-container"
                style=""
            >
                <div class="form-group" style="flex: unset !important">
                    <label for="pilih_riwayat_kunjungan_sebelumnya"
                        >Pilih Riwayat Kunjungan Sebelumnya
                        <span class="text-danger">*</span></label
                    >
                    <label class="select">
                        <select
                            myid="check_cara"
                            type="select"
                            name="pilih_riwayat_kunjungan_sebelumnya"
                            id="pilih_riwayat_kunjungan_sebelumnya"
                            class="select2 select2-hidden-accessible"
                            tabindex="-1"
                            aria-hidden="true"
                            data-is-mandatory="true"
                        >
                            <option></option></select
                        ><span
                            class="select2 select2-container select2-container--default"
                            dir="ltr"
                            style="width: 100%"
                            ><span class="selection"
                                ><span
                                    class="select2-selection select2-selection--single"
                                    role="combobox"
                                    aria-haspopup="true"
                                    aria-expanded="false"
                                    tabindex="-1"
                                    aria-labelledby="select2-pilih_riwayat_kunjungan_sebelumnya-container"
                                    ><span
                                        class="select2-selection__rendered"
                                        id="select2-pilih_riwayat_kunjungan_sebelumnya-container"
                                        ><span
                                            class="select2-selection__placeholder"
                                            >Select pilih riwayat kunjungan
                                            sebelumnya</span
                                        ></span
                                    ><span
                                        class="select2-selection__arrow"
                                        role="presentation"
                                        ><b
                                            role="presentation"
                                        ></b></span></span></span
                            ><span
                                class="dropdown-wrapper"
                                aria-hidden="true"
                            ></span
                            ><input
                                type="hidden"
                                myid="check_cara"
                                name="pilih_riwayat_kunjungan_sebelumnya_display"
                                value=""
                        /></span>
                    </label>
                    <div
                        id="disabled-visit-info"
                        class="disabled-visit-info"
                        style="display: none"
                    ></div>
                </div>
            </div>
        </div>

        <div id="medication-container" style="">
            <div class="medication-header">
                <div class="medication-header-text">
                    <div class="medication-title">Detail Obat</div>
                    <div class="medication-subtitle">
                        Pastikan dosis, frekuensi, dan periode sesuai dengan
                        resep pasien.
                    </div>
                </div>
            </div>

            <table class="medication-table">
                <thead>
                    <tr>
                        <th class="medication-col-name">
                            Nama Obat <span class="text-danger">*</span>
                        </th>
                        <th>Dosis <span class="text-danger">*</span></th>
                        <th>Frekuensi <span class="text-danger">*</span></th>
                        <th>Periode <span class="text-danger">*</span></th>
                        <th>Maksimal <span class="text-danger">*</span></th>
                        <th class="medication-col-unit">
                            Unit <span class="text-danger">*</span>
                        </th>
                    </tr>
                </thead>
                <tbody id="medication-rows">
                    <tr class="medication-row">
                        <td class="medication-col-name">
                            <div class="nama_obat_container">
                                <div class="nama_obat-display" title=""></div>
                                <input
                                    myid="check_cara"
                                    type="hidden"
                                    name="nama_obat[]"
                                    value=""
                                /><input
                                    myid="check_cara"
                                    type="hidden"
                                    name="nama_obat_display[]"
                                    value=""
                                /><input
                                    myid="check_cara"
                                    type="hidden"
                                    name="med_type[]"
                                    value=""
                                />
                            </div>
                        </td>
                        <td>
                            <input
                                myid="check_cara"
                                type="text"
                                name="dosis[]"
                                class="dosis is-invalid"
                                data-is-mandatory="true"
                                required=""
                                aria-invalid="true"
                            />
                            <div class="invalid-feedback">
                                Field ini wajib diisi
                            </div>
                        </td>
                        <td>
                            <input
                                myid="check_cara"
                                type="text"
                                name="frekuensi[]"
                                class="frekuensi is-invalid"
                                data-is-mandatory="true"
                                required=""
                                aria-invalid="true"
                            />
                            <div class="invalid-feedback">
                                Field ini wajib diisi
                            </div>
                        </td>
                        <td>
                            <input
                                myid="check_cara"
                                type="text"
                                name="periode[]"
                                class="periode is-invalid"
                                data-is-mandatory="true"
                                required=""
                                aria-invalid="true"
                            />
                            <div class="invalid-feedback">
                                Field ini wajib diisi
                            </div>
                        </td>
                        <td>
                            <input
                                myid="check_cara"
                                type="text"
                                name="maksimal[]"
                                class="maksimal is-invalid"
                                data-is-mandatory="true"
                                required=""
                                aria-invalid="true"
                            />
                            <div class="invalid-feedback">
                                Field ini wajib diisi
                            </div>
                        </td>
                        <td class="medication-col-unit">
                            <label class="select">
                                <select
                                    myid="check_cara"
                                    type="select"
                                    name="unit[]"
                                    class="unit select2 select2-hidden-accessible is-invalid"
                                    data-is-mandatory="true"
                                    tabindex="-1"
                                    aria-hidden="true"
                                    required=""
                                    aria-invalid="true"
                                >
                                    <option></option>
                                </select>
                                <div class="invalid-feedback">
                                    Field ini wajib diisi
                                </div>
                                <span
                                    class="select2 select2-container select2-container--default is-invalid"
                                    dir="ltr"
                                    style="width: 100%"
                                    aria-invalid="true"
                                    ><span class="selection"
                                        ><span
                                            class="select2-selection select2-selection--single is-invalid"
                                            role="combobox"
                                            aria-haspopup="true"
                                            aria-expanded="false"
                                            tabindex="0"
                                            aria-labelledby="select2-unit[]-tt-container"
                                            aria-invalid="true"
                                            ><span
                                                class="select2-selection__rendered"
                                                id="select2-unit[]-tt-container"
                                                title=""
                                            ></span
                                            ><span
                                                class="select2-selection__arrow"
                                                role="presentation"
                                                ><b
                                                    role="presentation"
                                                ></b></span></span></span
                                    ><span
                                        class="dropdown-wrapper"
                                        aria-hidden="true"
                                    ></span
                                    ><input
                                        type="hidden"
                                        myid="check_cara"
                                        name="unit_display[]"
                                        value=""
                                /></span>
                            </label>
                        </td>
                    </tr>
                </tbody>
            </table>

            <template id="medication-row-template">
                <tr class="medication-row">
                    <td class="medication-col-name">
                        <div class="nama_obat_container"></div>
                    </td>
                    <td>
                        <input
                            myid="check_cara"
                            type="text"
                            name="dosis[]"
                            class="dosis"
                            data-is-mandatory="true"
                        />
                    </td>
                    <td>
                        <input
                            myid="check_cara"
                            type="text"
                            name="frekuensi[]"
                            class="frekuensi"
                            data-is-mandatory="true"
                        />
                    </td>
                    <td>
                        <input
                            myid="check_cara"
                            type="text"
                            name="periode[]"
                            class="periode"
                            data-is-mandatory="true"
                        />
                    </td>
                    <td>
                        <input
                            myid="check_cara"
                            type="text"
                            name="maksimal[]"
                            class="maksimal"
                            data-is-mandatory="true"
                        />
                    </td>
                    <td class="medication-col-unit">
                        <label class="select">
                            <select
                                myid="check_cara"
                                type="select"
                                name="unit[]"
                                class="unit select2 select2-hidden-accessible"
                                data-is-mandatory="true"
                            >
                                <option></option>
                            </select>
                        </label>
                    </td>
                </tr>
            </template>
        </div>
    </div>

    <div
        class="section-header collapsible-trigger"
        data-target="#section2-content"
    >
        <div>
            <span class="section-number">2</span>
            IMPRESI KLINIS
            <small>ClinicalImpression</small>
        </div>
    </div>
    <div id="section2-content" class="collapsible-content">
        <div class="section-two-columns">
            <div class="left-column">
                <div class="form-group">
                    <label for="riwayat_penyakit_soap"
                        >Riwayat Penyakit SOAP
                        <span class="text-danger">*</span></label
                    >
                    <label class="textarea">
                        <textarea
                            myid="check_cara"
                            type="textarea"
                            name="riwayat_penyakit_soap"
                            id="riwayat_penyakit_soap"
                            rows="3"
                            class="custom-scroll"
                            data-is-mandatory="true"
                        ></textarea>
                    </label>
                </div>

                <div class="form-group">
                    <label for="keluhan_utama_soap"
                        >Keluhan Utama SOAP
                        <span class="text-danger">*</span></label
                    >
                    <label class="textarea">
                        <textarea
                            myid="check_cara"
                            type="textarea"
                            name="keluhan_utama"
                            id="keluhan_utama"
                            rows="3"
                            class="custom-scroll"
                            data-is-mandatory="true"
                        ></textarea>
                    </label>
                </div>

                <div class="form-group">
                    <label for="investigasi_penunjang_laboratorium"
                        >Investigasi Penunjang Laboratorium</label
                    >
                    <div class="helper-hint">
                        Berisi data laboratorium dari kunjungan saat ini apabila
                        tersedia.
                    </div>
                    <textarea
                        readonly=""
                        myid="check_cara"
                        type="textarea"
                        name="pemeriksaan_penunjang"
                        id="pemeriksaan_penunjang"
                        rows="3"
                        class="custom-scroll"
                        style="width: 100%"
                    ></textarea>
                </div>
            </div>

            <div class="right-column">
                <div class="form-group">
                    <label for="rencana_terapi_soap">Rencana Terapi SOAP</label>
                    <label class="textarea">
                        <textarea
                            myid="check_cara"
                            type="textarea"
                            name="rencana_terapi"
                            id="rencana_terapi"
                            rows="3"
                            class="custom-scroll"
                        ></textarea>
                    </label>
                </div>

                <div class="form-group">
                    <label for="prognosis_term"
                        >Prognosis Term
                        <span class="text-danger">*</span></label
                    >
                    <label class="select">
                        <select
                            myid="check_cara"
                            type="select"
                            name="prognosis_term"
                            id="prognosis_term"
                            class="select2 select2-hidden-accessible"
                            tabindex="-1"
                            aria-hidden="true"
                            data-is-mandatory="true"
                        >
                            <option></option>
                            {opt_prognosis_term}</select
                        ><span
                            class="select2 select2-container select2-container--default"
                            dir="ltr"
                            style="width: 100%"
                            ><span class="selection"
                                ><span
                                    class="select2-selection select2-selection--single"
                                    role="combobox"
                                    aria-haspopup="true"
                                    aria-expanded="false"
                                    tabindex="-1"
                                    aria-labelledby="select2-prognosis_term-container"
                                    ><span
                                        class="select2-selection__rendered"
                                        id="select2-prognosis_term-container"
                                        ><span
                                            class="select2-selection__placeholder"
                                            >Select prognosis term</span
                                        ></span
                                    ><span
                                        class="select2-selection__arrow"
                                        role="presentation"
                                        ><b
                                            role="presentation"
                                        ></b></span></span></span
                            ><span
                                class="dropdown-wrapper"
                                aria-hidden="true"
                            ></span
                            ><input
                                type="hidden"
                                myid="check_cara"
                                name="prognosis_term_display"
                                value=""
                        /></span>
                    </label>
                </div>
            </div>
        </div>
    </div>

    <div
        class="section-header collapsible-trigger"
        data-target="#section3-content"
    >
        <div>
            <span class="section-number">3</span>
            CARE PLAN
            <small>CarePlan</small>
        </div>
    </div>
    <div id="section3-content" class="collapsible-content">
        <div class="careplan-single-column">
            <div class="form-group">
                <label for="status_tindak_lanjut"
                    >Status Tindak Lanjut
                    <span class="text-danger">*</span></label
                >
                <label class="select">
                    <select
                        myid="check_cara"
                        type="select"
                        name="status_tindak_lanjut"
                        id="status_tindak_lanjut"
                        class="select2 select2-hidden-accessible"
                        tabindex="-1"
                        aria-hidden="true"
                        data-is-mandatory="true"
                    >
                        <option></option></select
                    ><span
                        class="select2 select2-container select2-container--default"
                        dir="ltr"
                        style="width: 100%"
                        ><span class="selection"
                            ><span
                                class="select2-selection select2-selection--single"
                                role="combobox"
                                aria-haspopup="true"
                                aria-expanded="false"
                                tabindex="-1"
                                aria-labelledby="select2-status_tindak_lanjut-container"
                                ><span
                                    class="select2-selection__rendered"
                                    id="select2-status_tindak_lanjut-container"
                                    ><span
                                        class="select2-selection__placeholder"
                                        >Select status tindak lanjut</span
                                    ></span
                                ><span
                                    class="select2-selection__arrow"
                                    role="presentation"
                                    ><b
                                        role="presentation"
                                    ></b></span></span></span
                        ><span
                            class="dropdown-wrapper"
                            aria-hidden="true"
                        ></span
                        ><input
                            type="hidden"
                            myid="check_cara"
                            name="status_tindak_lanjut_display"
                            value=""
                    /></span>
                </label>
            </div>
            <div class="form-group">
                <label for="tujuan_tindak_lanjut"
                    >Tujuan Tindak Lanjut
                    <span class="text-danger">*</span></label
                >
                <label class="select">
                    <select
                        myid="check_cara"
                        type="select"
                        name="tujuan_tindak_lanjut"
                        id="tujuan_tindak_lanjut"
                        class="select2 select2-hidden-accessible"
                        tabindex="-1"
                        aria-hidden="true"
                        data-is-mandatory="true"
                    >
                        <option></option></select
                    ><span
                        class="select2 select2-container select2-container--default"
                        dir="ltr"
                        style="width: 100%"
                        ><span class="selection"
                            ><span
                                class="select2-selection select2-selection--single"
                                role="combobox"
                                aria-haspopup="true"
                                aria-expanded="false"
                                tabindex="-1"
                                aria-labelledby="select2-tujuan_tindak_lanjut-container"
                                ><span
                                    class="select2-selection__rendered"
                                    id="select2-tujuan_tindak_lanjut-container"
                                    ><span
                                        class="select2-selection__placeholder"
                                        >Select tujuan tindak lanjut</span
                                    ></span
                                ><span
                                    class="select2-selection__arrow"
                                    role="presentation"
                                    ><b
                                        role="presentation"
                                    ></b></span></span></span
                        ><span
                            class="dropdown-wrapper"
                            aria-hidden="true"
                        ></span
                        ><input
                            type="hidden"
                            myid="check_cara"
                            name="tujuan_tindak_lanjut_display"
                            value=""
                    /></span>
                </label>
            </div>
            <div class="form-group">
                <label for="kategori_tindak_lanjut"
                    >Kategori Tindak Lanjut
                    <span class="text-danger">*</span></label
                >
                <label class="select">
                    <select
                        myid="check_cara"
                        type="select"
                        name="kategori_tindak_lanjut"
                        id="kategori_tindak_lanjut"
                        class="select2 select2-hidden-accessible"
                        tabindex="-1"
                        aria-hidden="true"
                        data-is-mandatory="true"
                    >
                        <option></option></select
                    ><span
                        class="select2 select2-container select2-container--default"
                        dir="ltr"
                        style="width: 100%"
                        ><span class="selection"
                            ><span
                                class="select2-selection select2-selection--single"
                                role="combobox"
                                aria-haspopup="true"
                                aria-expanded="false"
                                tabindex="-1"
                                aria-labelledby="select2-kategori_tindak_lanjut-container"
                                ><span
                                    class="select2-selection__rendered"
                                    id="select2-kategori_tindak_lanjut-container"
                                    ><span
                                        class="select2-selection__placeholder"
                                        >Select kategori tindak lanjut</span
                                    ></span
                                ><span
                                    class="select2-selection__arrow"
                                    role="presentation"
                                    ><b
                                        role="presentation"
                                    ></b></span></span></span
                        ><span
                            class="dropdown-wrapper"
                            aria-hidden="true"
                        ></span
                        ><input
                            type="hidden"
                            myid="check_cara"
                            name="kategori_tindak_lanjut_display"
                            value=""
                    /></span>
                </label>
            </div>
            <div class="form-group">
                <label for="tanggal_update_status"
                    >Tanggal Update Status
                    <span class="text-danger">*</span></label
                >
                <label class="input-with-icon">
                    <i class="icon-append fa fa-calendar"></i>
                    <input
                        myid="check_cara"
                        type="text"
                        name="tanggal_update_status"
                        id="tanggal_update_status"
                        class="datepicker hasDatepicker"
                        data-dateformat="dd/mm/yy"
                        data-is-mandatory="true"
                    />
                </label>
            </div>
        </div>
    </div>

    <div
        class="section-header collapsible-trigger"
        data-target="#section4-content"
    >
        <div>
            <span class="section-number">4</span>
            RENCANA TINDAK LANJUT KONTROL PASIEN
            <small>CarePlan</small>
        </div>
    </div>
    <div id="section4-content" class="collapsible-content">
        <div class="followup-grid">
            <div class="followup-card">
                <div class="followup-card__header">
                    <span class="followup-card__badge">Rencana Kontrol</span>
                    <span class="followup-card__hint"
                        >Atur jadwal dan alasan kontrol berikutnya dengan detail
                        yang jelas.</span
                    >
                </div>
                <div class="followup-card__body">
                    <div class="form-group">
                        <label for="tanggal_kontrol"
                            >Tanggal Kontrol
                            <span class="text-danger">*</span></label
                        >
                        <label class="input-with-icon">
                            <i class="icon-append fa fa-calendar"></i>
                            <input
                                myid="check_cara"
                                type="text"
                                name="tanggal_kontrol"
                                id="tanggal_kontrol"
                                class="datepicker hasDatepicker"
                                data-dateformat="dd/mm/yy"
                                data-is-mandatory="true"
                            />
                        </label>
                    </div>
                    <div class="form-group">
                        <label for="judul_surat_kontrol"
                            >Judul Surat Kontrol
                            <span class="text-danger">*</span></label
                        >
                        <input
                            myid="check_cara"
                            type="text"
                            name="judul_surat_kontrol"
                            id="judul_surat_kontrol"
                            data-is-mandatory="true"
                        />
                    </div>
                    <div class="form-group">
                        <label for="alasan_kontrol"
                            >Alasan Kontrol
                            <span class="text-danger">*</span></label
                        >
                        <textarea
                            myid="check_cara"
                            type="textarea"
                            name="alasan_kontrol"
                            id="alasan_kontrol"
                            rows="3"
                            class="custom-scroll"
                            data-is-mandatory="true"
                        ></textarea>
                    </div>
                </div>
            </div>

            <div class="followup-card">
                <div class="followup-card__header">
                    <span class="followup-card__badge">Rujukan &amp; Tim</span>
                    <span class="followup-card__hint"
                        >Tentukan layanan lanjutan beserta tenaga medis yang
                        bertanggung jawab.</span
                    >
                </div>
                <div class="followup-card__body">
                    <div class="form-group">
                        <label for="layanan_tindak_lajut"
                            >Layanan Tindak Lajut
                            <span class="text-danger">*</span></label
                        >
                        <label class="select">
                            <select
                                myid="check_cara"
                                type="select"
                                name="layanan_tindak_lajut"
                                id="layanan_tindak_lajut"
                                class="select2 select2-hidden-accessible"
                                tabindex="-1"
                                aria-hidden="true"
                                data-is-mandatory="true"
                            >
                                <option></option>
                                <option value="737481003">
                                    Rujukan Internal Rawat Inap
                                </option>
                                <option value="185389009">
                                    Rujukan Internal Kontrol Ulang
                                </option>
                                <option value="11429006">
                                    Rujukan Internal Konsultasi
                                </option>
                                <option value="737481003">
                                    Rujukan Eksternal Rawat Inap
                                </option>
                                <option value="737492002">
                                    Rujukan Eksternal Rawat Jalan
                                </option></select
                            ><span
                                class="select2 select2-container select2-container--default"
                                dir="ltr"
                                style="width: 100%"
                                ><span class="selection"
                                    ><span
                                        class="select2-selection select2-selection--single"
                                        role="combobox"
                                        aria-haspopup="true"
                                        aria-expanded="false"
                                        tabindex="-1"
                                        aria-labelledby="select2-layanan_tindak_lajut-container"
                                        ><span
                                            class="select2-selection__rendered"
                                            id="select2-layanan_tindak_lajut-container"
                                            ><span
                                                class="select2-selection__placeholder"
                                                >Select layanan tindak
                                                lajut</span
                                            ></span
                                        ><span
                                            class="select2-selection__arrow"
                                            role="presentation"
                                            ><b
                                                role="presentation"
                                            ></b></span></span></span
                                ><span
                                    class="dropdown-wrapper"
                                    aria-hidden="true"
                                ></span
                                ><input
                                    type="hidden"
                                    myid="check_cara"
                                    name="layanan_tindak_lajut_display"
                                    value=""
                            /></span>
                        </label>
                    </div>
                    <div class="form-group">
                        <label for="dokter_kontrol"
                            >Dokter Kontrol
                            <span class="text-danger">*</span></label
                        >
                        <label class="select">
                            <select
                                myid="check_cara"
                                type="select"
                                name="dokter_kontrol"
                                id="dokter_kontrol"
                                class="select2 select2-hidden-accessible"
                                tabindex="-1"
                                aria-hidden="true"
                                data-is-mandatory="true"
                            >
                                <option></option></select
                            ><span
                                class="select2 select2-container select2-container--default"
                                dir="ltr"
                                style="width: 100%"
                                ><span class="selection"
                                    ><span
                                        class="select2-selection select2-selection--single"
                                        role="combobox"
                                        aria-haspopup="true"
                                        aria-expanded="false"
                                        tabindex="-1"
                                        aria-labelledby="select2-dokter_kontrol-container"
                                        ><span
                                            class="select2-selection__rendered"
                                            id="select2-dokter_kontrol-container"
                                            ><span
                                                class="select2-selection__placeholder"
                                                >Select dokter kontrol</span
                                            ></span
                                        ><span
                                            class="select2-selection__arrow"
                                            role="presentation"
                                            ><b
                                                role="presentation"
                                            ></b></span></span></span
                                ><span
                                    class="dropdown-wrapper"
                                    aria-hidden="true"
                                ></span
                                ><input
                                    type="hidden"
                                    myid="check_cara"
                                    name="dokter_kontrol_display"
                                    value=""
                            /></span>
                        </label>
                    </div>
                    <div class="form-group">
                        <label for="estimasi_perawat">Estimasi Perawat</label>
                        <label class="select">
                            <select
                                myid="check_cara"
                                type="select"
                                name="estimasi_perawat"
                                id="estimasi_perawat"
                                class="select2 select2-hidden-accessible"
                                tabindex="-1"
                                aria-hidden="true"
                                data-is-mandatory="true"
                            >
                                <option></option></select
                            ><span
                                class="select2 select2-container select2-container--default"
                                dir="ltr"
                                style="width: 100%"
                                ><span class="selection"
                                    ><span
                                        class="select2-selection select2-selection--single"
                                        role="combobox"
                                        aria-haspopup="true"
                                        aria-expanded="false"
                                        tabindex="-1"
                                        aria-labelledby="select2-estimasi_perawat-container"
                                        ><span
                                            class="select2-selection__rendered"
                                            id="select2-estimasi_perawat-container"
                                            ><span
                                                class="select2-selection__placeholder"
                                                >Select estimasi perawat</span
                                            ></span
                                        ><span
                                            class="select2-selection__arrow"
                                            role="presentation"
                                            ><b
                                                role="presentation"
                                            ></b></span></span></span
                                ><span
                                    class="dropdown-wrapper"
                                    aria-hidden="true"
                                ></span
                                ><input
                                    type="hidden"
                                    myid="check_cara"
                                    name="estimasi_perawat_display"
                                    value=""
                            /></span>
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="signature-section">
        <div class="signature-box">
            <b>Dokter</b>
            <form class="smart-form" data-ttd="yes" style="font-size: 12px">
                <div class="row">
                    <div
                        id="def_img_doctor"
                        style="font-style: italic; width: 100px; height: 100px"
                    ></div>
                    <input
                        myid="check_cara"
                        type="hidden"
                        name="paraf_doctor"
                        id="paraf_doctor"
                        data-name="paraf"
                        data-id="doctor"
                    />
                    <img
                        id="image_paraf_doctor"
                        src=""
                        class="image-paraf"
                        style="display: none"
                    />
                    <br />
                    <a
                        id="CreateTTD"
                        class="btn btn-default btn-sm text-center"
                        data-id="doctor"
                    >
                        <i class="fa fa-edit"></i>
                        TTD PEN TABLET
                    </a>
                </div>
                <div class="row mt-5">
                    <label class="select">
                        <select
                            myid="check_cara"
                            class="select2 select2-hidden-accessible"
                            type="select"
                            name="doctor_ttd"
                            id="doctor_ttd"
                            data-var="set_name_sel"
                            data-id="doctor"
                            tabindex="-1"
                            aria-hidden="true"
                        >
                            <option></option>
                            {opt_doctor}</select
                        ><span
                            class="select2 select2-container select2-container--default"
                            dir="ltr"
                            style="width: 100%"
                            ><span class="selection"
                                ><span
                                    class="select2-selection select2-selection--single"
                                    role="combobox"
                                    aria-haspopup="true"
                                    aria-expanded="false"
                                    tabindex="0"
                                    aria-labelledby="select2-doctor_ttd-container"
                                    ><span
                                        class="select2-selection__rendered"
                                        id="select2-doctor_ttd-container"
                                        ><span
                                            class="select2-selection__placeholder"
                                            >Select doctor ttd</span
                                        ></span
                                    ><span
                                        class="select2-selection__arrow"
                                        role="presentation"
                                        ><b
                                            role="presentation"
                                        ></b></span></span></span
                            ><span
                                class="dropdown-wrapper"
                                aria-hidden="true"
                            ></span
                            ><input
                                type="hidden"
                                myid="check_cara"
                                name="doctor_ttd_display"
                                value=""
                        /></span>
                        <input
                            myid="check_cara"
                            type="hidden"
                            name="doctor_ttd_txt"
                            id="doctor_ttd_txt"
                        />
                    </label>
                </div>
            </form>
        </div>

        <div class="signature-box">
            <b>Perawat</b>
            <form class="smart-form" data-ttd="yes" style="font-size: 12px">
                <div class="row">
                    <div
                        id="def_img_nurse"
                        style="font-style: italic; width: 100px; height: 100px"
                    ></div>
                    <input
                        myid="check_cara"
                        type="hidden"
                        name="paraf_nurse"
                        id="paraf_nurse"
                        data-name="paraf"
                        data-id="nurse"
                    />
                    <img
                        id="image_paraf_nurse"
                        src=""
                        class="image-paraf"
                        style="display: none"
                    />
                    <br />
                    <a
                        id="CreateTTD"
                        class="btn btn-default btn-sm text-center"
                        data-id="nurse"
                    >
                        <i class="fa fa-edit"></i>
                        TTD PEN TABLET
                    </a>
                </div>
                <div class="row mt-5">
                    <label class="select">
                        <select
                            myid="check_cara"
                            class="select2 select2-hidden-accessible"
                            type="select"
                            name="nurse_ttd"
                            id="nurse_ttd"
                            data-var="set_name_sel"
                            data-id="nurse"
                            tabindex="-1"
                            aria-hidden="true"
                        >
                            <option></option>
                            {opt_nurse}</select
                        ><span
                            class="select2 select2-container select2-container--default"
                            dir="ltr"
                            style="width: 100%"
                            ><span class="selection"
                                ><span
                                    class="select2-selection select2-selection--single"
                                    role="combobox"
                                    aria-haspopup="true"
                                    aria-expanded="false"
                                    tabindex="0"
                                    aria-labelledby="select2-nurse_ttd-container"
                                    ><span
                                        class="select2-selection__rendered"
                                        id="select2-nurse_ttd-container"
                                        ><span
                                            class="select2-selection__placeholder"
                                            >Select nurse ttd</span
                                        ></span
                                    ><span
                                        class="select2-selection__arrow"
                                        role="presentation"
                                        ><b
                                            role="presentation"
                                        ></b></span></span></span
                            ><span
                                class="dropdown-wrapper"
                                aria-hidden="true"
                            ></span
                            ><input
                                type="hidden"
                                myid="check_cara"
                                name="nurse_ttd_display"
                                value=""
                        /></span>
                        <input
                            myid="check_cara"
                            type="hidden"
                            name="nurse_ttd_txt"
                            id="nurse_ttd_txt"
                        />
                    </label>
                </div>
            </form>
        </div>
    </div>
</div>

<div
    class="modal fade"
    id="myModal"
    tabindex="-1"
    role="dialog"
    aria-labelledby="myModal"
    aria-hidden="true"
>
    <div class="modal-dialog modal-xl">
        <div class="modal-content padding-15">
            <div class="modal-body"></div>
        </div>
    </div>
</div>
